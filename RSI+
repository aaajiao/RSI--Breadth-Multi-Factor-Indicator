//@version=6
indicator("RSI+Breadth Multi-Factor v6", overlay=true, max_labels_count=500, max_bars_back=1100)

//==============================================================================
// SIGNAL TERMINOLOGY & EMOJI REFERENCE ä¿¡å·æœ¯è¯­ä¸è¡¨æƒ…å‚è€ƒ
//==============================================================================
// Multi-factor scoring: RSI + Market Breadth (TW/FI) + Up/Down Volume + Divergence
// å¤šå› å­è¯„åˆ†ç³»ç»Ÿï¼šRSI + å¸‚åœºå¹¿åº¦ (TW/FI) + ä¸Šæ¶¨/ä¸‹è·Œæˆäº¤é‡ + èƒŒç¦»
//
// SIGNAL LEVELS ä¿¡å·çº§åˆ«:
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ Score â”‚ Emoji â”‚ Signal      â”‚ ä¸­æ–‡     â”‚ Action æ“ä½œå»ºè®®                  â”‚
// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
// â”‚ >= 6  â”‚ ğŸš€    â”‚ PANIC LOW   â”‚ ææ…Œä½ç‚¹ â”‚ Strong buy å¼ºçƒˆä¹°å…¥              â”‚
// â”‚ >= 4  â”‚ ğŸ“ˆ    â”‚ BUY ZONE    â”‚ ä½å¸åŒº   â”‚ Accumulate åˆ†æ‰¹å»ºä»“              â”‚
// â”‚ -3~3  â”‚ -     â”‚ HOLD        â”‚ æŒæœ‰     â”‚ Hold position æŒä»“è§‚æœ›           â”‚
// â”‚ <=-4â†‘ â”‚ â­    â”‚ ELEVATED    â”‚ é«˜ä¼°     â”‚ Hold cautious æŒæœ‰ä½†è°¨æ…         â”‚
// â”‚ <=-4â†“ â”‚ âš¡    â”‚ CAUTION     â”‚ è§‚æœ›     â”‚ Take profit æ­¢ç›ˆ                 â”‚
// â”‚ <=-6â†“ â”‚ âš ï¸    â”‚ REDUCE      â”‚ å‡ä»“     â”‚ Reduce position å‡å°‘ä»“ä½         â”‚
// â”‚  DIV  â”‚ ğŸ’    â”‚ DIVERGENCE  â”‚ èƒŒç¦»     â”‚ Reversal confirmation åè½¬ç¡®è®¤   â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
// â†‘ = Uptrend ä¸Šå‡è¶‹åŠ¿ (price > MA)  â†“ = Downtrend ä¸‹é™è¶‹åŠ¿ (price < MA)
//
// RESONANCE å…±æŒ¯ä¿¡å·:
// ğŸ”¥ Resonance Buy  å…±æŒ¯ä¹°å…¥ - Multiple markets in buy zone å¤šå¸‚åœºåŒæ—¶ä½å¸
// â„ï¸ Resonance Risk å…±æŒ¯é£é™© - Multiple markets in risk zone å¤šå¸‚åœºåŒæ—¶é«˜ä¼°
//==============================================================================

//========================
// Mode (è¯„åˆ†é˜ˆå€¼è°ƒæ•´)
//========================
grpMode = "Mode / æ¨¡å¼"
mode = input.string("Standard", "Signal Mode / ä¿¡å·æ¨¡å¼", options=["Aggressive","Standard","Conservative"], group=grpMode)

//========================
// Adaptive Settings (è‡ªé€‚åº”è®¾ç½®)
//========================
grpAdaptive = "Adaptive / è‡ªé€‚åº”"

// Lookback æ¨¡å¼é€‰æ‹©
lookbackMode = input.string("Auto", "Lookback Mode / å›æº¯æ¨¡å¼", options=["Auto", "Fixed 252", "Custom"], group=grpAdaptive, tooltip="Auto: ä½¿ç”¨ç»Ÿè®¡å…¬å¼è‡ªé€‚åº”è®¡ç®—\\nFixed 252: ä¼ ç»Ÿå›ºå®š1å¹´\\nCustom: è‡ªå®šä¹‰æ•°å€¼")
lookbackCustom = input.int(252, "Custom Lookback / è‡ªå®šä¹‰å›æº¯", minval=100, maxval=1000, group=grpAdaptive)

// ç²¾åº¦æ§åˆ¶ï¼ˆå¤§ç›˜æŒ‡æ•°ä¼˜åŒ–ä¸º High é»˜è®¤ï¼‰
lookbackPrecision = input.string("High", "Lookback Precision / å›æº¯ç²¾åº¦", options=["High", "Normal", "Low"], group=grpAdaptive, tooltip="High: E=2.0 æ›´ç²¾ç¡®(Lookbackæ›´é•¿)\\nNormal: E=2.5 å¹³è¡¡\\nLow: E=3.5 æ›´å¿«(Lookbackæ›´çŸ­)")

// é•¿æœŸæ³¢åŠ¨å†å²æ·±åº¦
volHistoryMode = input.string("1 Year", "Vol History / æ³¢åŠ¨å†å²", options=["6 Months", "1 Year", "2 Years"], group=grpAdaptive, tooltip="é•¿æœŸæ³¢åŠ¨ç‡çš„å†å²æ·±åº¦")

// Threshold Mode
thresholdMode = input.string("Auto", "Threshold Mode / é˜ˆå€¼æ¨¡å¼", options=["Auto", "Fixed", "Adaptive"], group=grpAdaptive, tooltip="Auto: æ ¹æ®RSIæ³¢åŠ¨ç‡è‡ªåŠ¨é€‰æ‹©\\nFixed: ä½¿ç”¨å›ºå®šé˜ˆå€¼\\nAdaptive: ä½¿ç”¨å†å²ç™¾åˆ†ä½é˜ˆå€¼")

// RSI æ³¢åŠ¨é˜ˆå€¼ï¼ˆå¤§ç›˜æŒ‡æ•°ä¼˜åŒ–ä¸º 8.0ï¼‰
rsiVolThreshold = input.float(8.0, "RSI Vol Threshold / RSIæ³¢åŠ¨é˜ˆå€¼", minval=5.0, maxval=20.0, group=grpAdaptive, tooltip="Autoæ¨¡å¼ä¸‹,RSIæ ‡å‡†å·®é«˜äºæ­¤å€¼åˆ™ä½¿ç”¨è‡ªé€‚åº”\\nå¤§ç›˜æŒ‡æ•°å»ºè®®: 8.0\\nä¸ªè‚¡å»ºè®®: 10.0")

//========================
// Core Inputs
//========================
grp1 = "Core Settings / æ ¸å¿ƒè®¾ç½®"
rsiLen = input.int(14, "RSI Length / RSIå‘¨æœŸ", minval=2, group=grp1)

// è‡ªåŠ¨è·å–å›¾è¡¨å‘¨æœŸ
tfData = timeframe.period
intradayMode = timeframe.isintraday

//========================
// Fixed Thresholds (å›ºå®šé˜ˆå€¼ - å¯é…ç½®)
//========================
grpFixedThresh = "Fixed Thresholds / å›ºå®šé˜ˆå€¼"
fixedRsiOversold1 = input.int(30, "RSI Oversold Lv1 / è¶…å–1", minval=10, maxval=40, group=grpFixedThresh)
fixedRsiOversold2 = input.int(40, "RSI Oversold Lv2 / è¶…å–2", minval=20, maxval=50, group=grpFixedThresh)
fixedRsiOverbought1 = input.int(75, "RSI Overbought Lv1 / è¶…ä¹°1", minval=60, maxval=90, group=grpFixedThresh)
fixedRsiOverbought2 = input.int(65, "RSI Overbought Lv2 / è¶…ä¹°2", minval=50, maxval=80, group=grpFixedThresh)

grp2 = "Signal Thresholds / ä¿¡å·é˜ˆå€¼"
strongBotThreshold = input.int(6, "Panic Low Threshold / ææ…Œä½ç‚¹", minval=3, maxval=10, group=grp2)
botThreshold = input.int(4, "Buy Zone Threshold / ä½å¸åŒº", minval=2, maxval=8, group=grp2)
topThreshold = input.int(-4, "Caution Zone Threshold / è§‚æœ›", minval=-8, maxval=-2, group=grp2)
strongTopThreshold = input.int(-6, "Risk Zone Threshold / å‡ä»“", minval=-10, maxval=-3, group=grp2)

grp3 = "Signal Logic / ä¿¡å·é€»è¾‘"
cooldownIn = input.int(10, "Cooldown Bars / å†·å´å‘¨æœŸ", minval=0, group=grp3)
confirmBars = input.int(3, "Resonance Window / å…±æŒ¯çª—å£", minval=0, group=grp3)
minAgree = input.int(2, "Min Markets for Resonance / å…±æŒ¯æœ€å°å¸‚åœºæ•°", minval=1, maxval=3, group=grp3)

//========================
// Divergence Settings (èƒŒç¦»è®¾ç½®)
//========================
grpDiv = "Divergence / èƒŒç¦»"
useDivergence = input.bool(true, "Enable Divergence / å¯ç”¨èƒŒç¦»", group=grpDiv)
divZScoreThreshold = input.float(1.5, "Divergence Z-Score / èƒŒç¦»å¼ºåº¦é˜ˆå€¼", minval=0.5, maxval=3.0, step=0.1, group=grpDiv, tooltip="ä»·æ ¼ä¸RSIçš„Z-Scoreå·®å€¼è¶…è¿‡æ­¤é˜ˆå€¼æ—¶è§¦å‘èƒŒç¦»")

//========================
// Trend Filter (è¶‹åŠ¿è¿‡æ»¤)
//========================
grp3b = "Trend Filter / è¶‹åŠ¿è¿‡æ»¤"
trendMALen = input.int(10, "Trend MA Length / è¶‹åŠ¿å‡çº¿å‘¨æœŸ", minval=5, maxval=50, group=grp3b)
useTrendFilter = input.bool(true, "Enable Trend Filter / å¯ç”¨è¶‹åŠ¿è¿‡æ»¤", group=grp3b)

//========================
// Symbols
//========================
grp5 = "Symbols / æ ‡çš„"
spySym = input.symbol("AMEX:SPY", "SPY", group=grp5)
qqqSym = input.symbol("NASDAQ:QQQ", "QQQ", group=grp5)
iwmSym = input.symbol("AMEX:IWM", "Russell2000 (IWM)", group=grp5)

s5twSym = input.symbol("INDEX:S5TW", "S5TW (% > 20D MA)", group=grp5)
s5fiSym = input.symbol("INDEX:S5FI", "S5FI (% > 50D MA)", group=grp5)
nctwSym = input.symbol("INDEX:NCTW", "NCTW (% > 20D MA)", group=grp5)
ncfiSym = input.symbol("INDEX:NCFI", "NCFI (% > 50D MA)", group=grp5)
r2twSym = input.symbol("INDEX:R2TW", "R2TW (% > 20D MA)", group=grp5)
r2fiSym = input.symbol("INDEX:R2FI", "R2FI (% > 50D MA)", group=grp5)

grp5b = "Volume Breadth / æˆäº¤é‡å¹¿åº¦"
uvolSym = input.symbol("USI:UVOL", "Up Volume (NYSE)", group=grp5b)
dvolSym = input.symbol("USI:DVOL", "Down Volume (NYSE)", group=grp5b)
uvolqSym = input.symbol("USI:UVOLQ", "Up Volume (NASDAQ)", group=grp5b)
dvolqSym = input.symbol("USI:DVOLQ", "Down Volume (NASDAQ)", group=grp5b)
addSym = input.symbol("USI:ADD", "Advance-Decline (Intraday)", group=grp5b, tooltip="æ—¥å†…æ¨¡å¼ä¸‹ç”¨äºå¹¿åº¦ä»£ç†")

grp6 = "Plot / æ˜¾ç¤º"
plotMode = input.string("AUTO", "Display Mode / æ˜¾ç¤ºæ¨¡å¼", options=["AUTO","SPY","QQQ","IWM","AGG(å…±æŒ¯)"], group=grp6)
showDashboard = input.bool(true, "Show Dashboard / æ˜¾ç¤ºé¢æ¿", group=grp6)

//========================
// Mode presets
//========================
modeAdjust = mode == "Aggressive" ? 1 : mode == "Conservative" ? -1 : 0
intradayAdjust = intradayMode ? 2 : 0
adjBotThreshold = botThreshold - modeAdjust - intradayAdjust
adjStrongBotThreshold = strongBotThreshold - modeAdjust - intradayAdjust
adjTopThreshold = topThreshold + modeAdjust + intradayAdjust
adjStrongTopThreshold = strongTopThreshold + modeAdjust + intradayAdjust
cooldownBars = mode == "Aggressive" ? 5 : mode == "Conservative" ? 15 : cooldownIn

//========================
// Helpers
//========================
f_sec(_sym, _expr) =>
    request.security(_sym, tfData, _expr, barmerge.gaps_off, barmerge.lookahead_off)

f_ohlc(_sym) =>
    request.security(_sym, tfData, [open, high, low, close], barmerge.gaps_off, barmerge.lookahead_off)

f_secDaily(_sym, _expr) =>
    request.security(_sym, "D", _expr, barmerge.gaps_off, barmerge.lookahead_off)

f_rsi_from_close(_c) =>
    ta.rsi(_c, rsiLen)

f_recent(_cond, _bars) =>
    if _bars == 0
        _cond
    else
        bs = ta.barssince(_cond)
        not na(bs) and bs <= _bars

f_applyCooldown(_rawSig, _coolBars, _lastBar) =>
    can = na(_lastBar) or (bar_index - _lastBar > _coolBars)
    _rawSig and (_coolBars == 0 or can)

//========================
// Adaptive Threshold Calculation (è‡ªé€‚åº”é˜ˆå€¼è®¡ç®—)
//========================
f_adaptiveThresholds(_rsi, _lookback) =>
    // å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿ lookback ä¸è¶…è¿‡å¯ç”¨çš„å†å²æ•°æ®
    // Pine Script çš„ percentile å‡½æ•°éœ€è¦è‡³å°‘ lookback+1 æ ¹ bar
    // åŒæ—¶ç¡®ä¿æœ€å°å€¼ä¸º 10ï¼Œä¿è¯ç™¾åˆ†ä½è®¡ç®—æœ‰æ„ä¹‰
    safe_lookback = math.max(10, math.min(_lookback, bar_index - 1))
    
    oversold1 = ta.percentile_linear_interpolation(_rsi, safe_lookback, 10)
    oversold2 = ta.percentile_linear_interpolation(_rsi, safe_lookback, 20)
    overbought1 = ta.percentile_linear_interpolation(_rsi, safe_lookback, 90)
    overbought2 = ta.percentile_linear_interpolation(_rsi, safe_lookback, 80)
    [oversold1, oversold2, overbought1, overbought2]

//========================
// Scoring Functions (è¯„åˆ†å‡½æ•°)
//========================
f_rsiScore(_rsi, _oversold1, _oversold2, _overbought1, _overbought2) =>
    score = 0.0
    if not na(_rsi)
        if _rsi < _oversold1
            score := 2
        else if _rsi < _oversold2
            score := 1
        else if _rsi > _overbought1
            score := -2
        else if _rsi > _overbought2
            score := -1
    score

f_fiScore(_fi) =>
    score = 0.0
    if not na(_fi)
        if _fi < 25
            score := 3
        else if _fi < 35
            score := 2
        else if _fi < 45
            score := 1
        else if _fi > 85
            score := -2
        else if _fi > 78
            score := -1
    score

f_twScore(_tw) =>
    score = 0.0
    if not na(_tw)
        if _tw > 82
            score := -3
        else if _tw > 72
            score := -2
        else if _tw > 68
            score := -1
        else if _tw < 30
            score := 1
    score

f_volScore(_uvol, _dvol) =>
    score = 0.0
    if not na(_uvol) and not na(_dvol) and _dvol > 0
        ratio = _uvol / _dvol
        if ratio < 0.5
            score := 2
        else if ratio < 0.8
            score := 1
        else if ratio > 2.5
            score := -2
        else if ratio > 1.8
            score := -1
    score

// æ—¥å†…å¹¿åº¦è¯„åˆ† (ä½¿ç”¨ ADD)
f_addScore(_add) =>
    score = 0.0
    if not na(_add)
        if _add < -1500
            score := 3
        else if _add < -500
            score := 2
        else if _add < 0
            score := 1
        else if _add > 1500
            score := -3
        else if _add > 500
            score := -2
        else if _add > 0
            score := -1
    score

//========================
// Divergence Detection (èƒŒç¦»æ£€æµ‹)
//========================
f_divergence(_close, _rsi, _lookback) =>
    priceMA = ta.sma(_close, _lookback)
    priceStd = ta.stdev(_close, _lookback)
    rsiMA = ta.sma(_rsi, _lookback)
    rsiStd = ta.stdev(_rsi, _lookback)
    
    priceZ = priceStd > 0 ? (_close - priceMA) / priceStd : 0
    rsiZ = rsiStd > 0 ? (_rsi - rsiMA) / rsiStd : 0
    
    divStrength = priceZ - rsiZ
    [divStrength, priceZ, rsiZ]

//========================
// Total Score Function (ç»¼åˆè¯„åˆ†)
//========================
f_totalScore(_rsi, _tw, _fi, _uvol, _dvol, _add, _intraday, _oversold1, _oversold2, _overbought1, _overbought2) =>
    rsiS = f_rsiScore(_rsi, _oversold1, _oversold2, _overbought1, _overbought2)
    volS = f_volScore(_uvol, _dvol)
    
    fiS = 0.0
    twS = 0.0
    addS = 0.0
    
    if _intraday
        addS := f_addScore(_add)
    else
        fiS := f_fiScore(_fi)
        twS := f_twScore(_tw)
    
    total = rsiS + fiS + twS + volS + addS
    [total, rsiS, fiS, twS, volS, addS]

//========================
// Signal Generation Function (ä¿¡å·ç”Ÿæˆ - æ¨¡å—åŒ–)
//========================
f_generateSignals(_score, _uptrend, _adjBotTh, _adjStrongBotTh, _adjTopTh, _adjStrongTopTh) =>
    strongBot = _score >= _adjStrongBotTh
    bot = _score >= _adjBotTh and _score < _adjStrongBotTh
    topCond = _score <= _adjTopTh and _score > _adjStrongTopTh
    strongTopCond = _score <= _adjStrongTopTh
    top = topCond and (not useTrendFilter or not _uptrend)
    strongTop = strongTopCond and (not useTrendFilter or not _uptrend)
    elevated = (topCond or strongTopCond) and _uptrend and useTrendFilter
    [strongBot, bot, top, strongTop, elevated, strongBot or bot, strongTop or top]

//========================
// Market data
//========================
[spyO, spyH, spyL, spyC] = f_ohlc(spySym)
[qqqO, qqqH, qqqL, qqqC] = f_ohlc(qqqSym)
[iwmO, iwmH, iwmL, iwmC] = f_ohlc(iwmSym)

spyRSI = f_rsi_from_close(spyC)
qqqRSI = f_rsi_from_close(qqqC)
iwmRSI = f_rsi_from_close(iwmC)

s5tw = f_secDaily(s5twSym, close)
s5fi = f_secDaily(s5fiSym, close)
nctw = f_secDaily(nctwSym, close)
ncfi = f_secDaily(ncfiSym, close)
r2tw = f_secDaily(r2twSym, close)
r2fi = f_secDaily(r2fiSym, close)

uvol = f_secDaily(uvolSym, close)
dvol = f_secDaily(dvolSym, close)
uvolq = f_secDaily(uvolqSym, close)
dvolq = f_secDaily(dvolqSym, close)

// Intraday breadth proxy
addValue = f_sec(addSym, close)

//========================
// Dual Volatility System & Auto-Adaptive Lookback (åŒé‡æ³¢åŠ¨ç‡ç³»ç»Ÿ)
//========================

// Step 1: çŸ­æœŸæ³¢åŠ¨ï¼ˆè‡ªé€‚åº”åˆ° RSI é•¿åº¦ï¼‰
vol_short_period = rsiLen * 4
vol_short = ta.stdev(spyRSI, vol_short_period)

// Step 2: é•¿æœŸæ³¢åŠ¨ï¼ˆæ ¹æ®ç”¨æˆ·é€‰æ‹©çš„å†å²æ·±åº¦ï¼‰
vol_history_days = volHistoryMode == "6 Months" ? 126 : volHistoryMode == "1 Year" ? 252 : 504

// æ ¹æ®æ—¶é—´æ¡†æ¶è°ƒæ•´ï¼ˆç¡®ä¿è¦†ç›–ç›¸åŒå¤©æ•°ï¼‰
tf_minutes = timeframe.in_seconds(timeframe.period) / 60
bars_per_day = timeframe.isdaily or timeframe.isweekly or timeframe.ismonthly ? 1 : math.ceil(1440 / tf_minutes)
vol_long_period = math.min(1000, vol_history_days * bars_per_day)
vol_long = ta.stdev(spyRSI, vol_long_period)

// Step 3: åŠ¨æ€åŠ æƒç»„åˆ
// åŸºç¡€ï¼š70% é•¿æœŸ + 30% çŸ­æœŸï¼ˆåå‘ç¨³å®šï¼‰
vol_base = vol_long * 0.7 + vol_short * 0.3

// å¦‚æœè¿‘æœŸæ³¢åŠ¨æ˜¾è‘—é«˜äºé•¿æœŸï¼ˆ> 1.2å€ï¼‰ï¼Œåˆ‡æ¢åˆ°çŸ­æœŸä¸»å¯¼
recent_high = vol_short > vol_long * 1.2
vol_dynamic = recent_high ? (vol_short * 0.6 + vol_long * 0.4) : vol_base

// ä¿å®ˆä¸‹é™ï¼šä¸ä½äºé•¿æœŸæ³¢åŠ¨çš„ 80%
vol_final = math.max(vol_dynamic, vol_long * 0.8)

// Step 4: ç»Ÿè®¡å…¬å¼è®¡ç®— Lookback
// n = (Z Ã— Ïƒ / E)Â²  å…¶ä¸­ Z=1.96 (95%ç½®ä¿¡åº¦)
stat_error = lookbackPrecision == "High" ? 2.0 : lookbackPrecision == "Normal" ? 2.5 : 3.5
stat_required = math.pow(1.96 * vol_final / stat_error, 2)
auto_lookback = int(math.max(100, math.min(1000, stat_required)))

// Step 5: åº”ç”¨æ¨¡å¼é€‰æ‹©
adaptiveLookback_raw = lookbackMode == "Custom" ? lookbackCustom : 
                       lookbackMode == "Fixed 252" ? 252 : auto_lookback

// Step 6: å®‰å…¨é™åˆ¶ - ç¡®ä¿ä¸è¶…è¿‡å¯ç”¨å†å²æ•°æ®
// åœ¨å›¾è¡¨æ—©æœŸï¼Œbar_index å¯èƒ½å°äºè®¡ç®—å‡ºçš„ lookback
adaptiveLookback = int(math.min(adaptiveLookback_raw, bar_index))

// Step 7: å¥åº·åº¦æŒ‡æ ‡ï¼ˆå¤§ç›˜æŒ‡æ•°ä¼˜åŒ–ï¼šåˆ†å¸ƒå®½åº¦é˜ˆå€¼ 12ï¼‰
health_sample_coverage = bar_index >= adaptiveLookback_raw * 0.8
health_stat_valid = adaptiveLookback >= stat_required * 0.9

//========================
// Adaptive Threshold Selection (è‡ªé€‚åº”é˜ˆå€¼é€‰æ‹©)
//========================

// åŒé‡æ£€æµ‹ç³»ç»Ÿï¼ˆå¿«é€Ÿè§¦å‘ + æ…¢é€Ÿç¡®è®¤ï¼‰
vol_fast_period = int(rsiLen * 1.5)  // å¿«é€Ÿæ£€æµ‹ï¼šçº¦ 21 æ ¹ K çº¿ï¼ˆå¦‚æœ RSI=14ï¼‰
vol_fast = ta.stdev(spyRSI, vol_fast_period)

vol_slow_period = int(rsiLen * 3)    // æ…¢é€Ÿç¡®è®¤ï¼šçº¦ 42 æ ¹ K çº¿
vol_slow = ta.stdev(spyRSI, vol_slow_period)

// è‡ªåŠ¨æ¨¡å¼é€»è¾‘ï¼šå¿«é€Ÿæ£€æµ‹ OR æ…¢é€Ÿç¡®è®¤
useAdaptive = thresholdMode == "Auto" ? 
              (vol_fast > rsiVolThreshold or vol_slow > rsiVolThreshold * 1.2) : 
              thresholdMode == "Adaptive"

[spyAdaptOS1, spyAdaptOS2, spyAdaptOB1, spyAdaptOB2] = f_adaptiveThresholds(spyRSI, adaptiveLookback)
[qqqAdaptOS1, qqqAdaptOS2, qqqAdaptOB1, qqqAdaptOB2] = f_adaptiveThresholds(qqqRSI, adaptiveLookback)
[iwmAdaptOS1, iwmAdaptOS2, iwmAdaptOB1, iwmAdaptOB2] = f_adaptiveThresholds(iwmRSI, adaptiveLookback)

spyOS1 = useAdaptive ? spyAdaptOS1 : fixedRsiOversold1
spyOS2 = useAdaptive ? spyAdaptOS2 : fixedRsiOversold2
spyOB1 = useAdaptive ? spyAdaptOB1 : fixedRsiOverbought1
spyOB2 = useAdaptive ? spyAdaptOB2 : fixedRsiOverbought2

qqqOS1 = useAdaptive ? qqqAdaptOS1 : fixedRsiOversold1
qqqOS2 = useAdaptive ? qqqAdaptOS2 : fixedRsiOversold2
qqqOB1 = useAdaptive ? qqqAdaptOB1 : fixedRsiOverbought1
qqqOB2 = useAdaptive ? qqqAdaptOB2 : fixedRsiOverbought2

iwmOS1 = useAdaptive ? iwmAdaptOS1 : fixedRsiOversold1
iwmOS2 = useAdaptive ? iwmAdaptOS2 : fixedRsiOversold2
iwmOB1 = useAdaptive ? iwmAdaptOB1 : fixedRsiOverbought1
iwmOB2 = useAdaptive ? iwmAdaptOB2 : fixedRsiOverbought2

// å¥åº·åº¦ï¼šåˆ†å¸ƒå®½åº¦æ£€æŸ¥ï¼ˆå¤§ç›˜æŒ‡æ•°ä¼˜åŒ–ï¼šâ‰¥12ï¼‰
health_distribution_spread = (spyOB1 - spyOS1) >= 12
health_ok = health_sample_coverage and health_stat_valid and health_distribution_spread

//========================
// Calculate Scores per Market
//========================
[spyScore, spyRsiS, spyFiS, spyTwS, spyVolS, spyAddS] = f_totalScore(spyRSI, s5tw, s5fi, uvol, dvol, addValue, intradayMode, spyOS1, spyOS2, spyOB1, spyOB2)
[qqqScore, qqqRsiS, qqqFiS, qqqTwS, qqqVolS, qqqAddS] = f_totalScore(qqqRSI, nctw, ncfi, uvolq, dvolq, addValue, intradayMode, qqqOS1, qqqOS2, qqqOB1, qqqOB2)
[iwmScore, iwmRsiS, iwmFiS, iwmTwS, iwmVolS, iwmAddS] = f_totalScore(iwmRSI, r2tw, r2fi, uvol, dvol, addValue, intradayMode, iwmOS1, iwmOS2, iwmOB1, iwmOB2)

//========================
// Divergence Calculation
//========================
// åŠ¨æ€èƒŒç¦»å›æº¯æœŸï¼ˆå…³è” RSI é•¿åº¦ï¼‰
div_lookback = int(rsiLen * 4)  // å¦‚æœ RSI=14ï¼Œåˆ™ 56 æ ¹ K çº¿

[spyDivStrength, spyPriceZ, spyRsiZ] = f_divergence(spyC, spyRSI, div_lookback)
[qqqDivStrength, qqqPriceZ, qqqRsiZ] = f_divergence(qqqC, qqqRSI, div_lookback)
[iwmDivStrength, iwmPriceZ, iwmRsiZ] = f_divergence(iwmC, iwmRSI, div_lookback)

spyBullishDiv = useDivergence and spyDivStrength < -divZScoreThreshold and spyRSI < spyOS2
spyBearishDiv = useDivergence and spyDivStrength > divZScoreThreshold and spyRSI > spyOB2
qqqBullishDiv = useDivergence and qqqDivStrength < -divZScoreThreshold and qqqRSI < qqqOS2
qqqBearishDiv = useDivergence and qqqDivStrength > divZScoreThreshold and qqqRSI > qqqOB2
iwmBullishDiv = useDivergence and iwmDivStrength < -divZScoreThreshold and iwmRSI < iwmOS2
iwmBearishDiv = useDivergence and iwmDivStrength > divZScoreThreshold and iwmRSI > iwmOB2

//========================
// Trend MA & Signals (using modular function)
//========================
spyTrendMA = ta.sma(spyC, trendMALen)
qqqTrendMA = ta.sma(qqqC, trendMALen)
iwmTrendMA = ta.sma(iwmC, trendMALen)

spyUptrend = spyC > spyTrendMA
qqqUptrend = qqqC > qqqTrendMA
iwmUptrend = iwmC > iwmTrendMA

[spyStrongBot, spyBot, spyTop, spyStrongTop, spyElevated, spyBotRaw, spyTopRaw] = f_generateSignals(spyScore, spyUptrend, adjBotThreshold, adjStrongBotThreshold, adjTopThreshold, adjStrongTopThreshold)
[qqqStrongBot, qqqBot, qqqTop, qqqStrongTop, qqqElevated, qqqBotRaw, qqqTopRaw] = f_generateSignals(qqqScore, qqqUptrend, adjBotThreshold, adjStrongBotThreshold, adjTopThreshold, adjStrongTopThreshold)
[iwmStrongBot, iwmBot, iwmTop, iwmStrongTop, iwmElevated, iwmBotRaw, iwmTopRaw] = f_generateSignals(iwmScore, iwmUptrend, adjBotThreshold, adjStrongBotThreshold, adjTopThreshold, adjStrongTopThreshold)

//========================
// Cooldown state
//========================
var int spyLastBot = na
var int spyLastTop = na
var int qqqLastBot = na
var int qqqLastTop = na
var int iwmLastBot = na
var int iwmLastTop = na

spyBotTrig = f_applyCooldown(spyBotRaw, cooldownBars, spyLastBot)
spyTopTrig = f_applyCooldown(spyTopRaw, cooldownBars, spyLastTop)
qqqBotTrig = f_applyCooldown(qqqBotRaw, cooldownBars, qqqLastBot)
qqqTopTrig = f_applyCooldown(qqqTopRaw, cooldownBars, qqqLastTop)
iwmBotTrig = f_applyCooldown(iwmBotRaw, cooldownBars, iwmLastBot)
iwmTopTrig = f_applyCooldown(iwmTopRaw, cooldownBars, iwmLastTop)

if spyBotTrig
    spyLastBot := bar_index
if spyTopTrig
    spyLastTop := bar_index
if qqqBotTrig
    qqqLastBot := bar_index
if qqqTopTrig
    qqqLastTop := bar_index
if iwmBotTrig
    iwmLastBot := bar_index
if iwmTopTrig
    iwmLastTop := bar_index

//========================
// Aggregate resonance
//========================
spyBotRecent = f_recent(spyBotTrig, confirmBars)
qqqBotRecent = f_recent(qqqBotTrig, confirmBars)
iwmBotRecent = f_recent(iwmBotTrig, confirmBars)

spyTopRecent = f_recent(spyTopTrig, confirmBars)
qqqTopRecent = f_recent(qqqTopTrig, confirmBars)
iwmTopRecent = f_recent(iwmTopTrig, confirmBars)

agreeBot = (spyBotRecent ? 1 : 0) + (qqqBotRecent ? 1 : 0) + (iwmBotRecent ? 1 : 0)
agreeTop = (spyTopRecent ? 1 : 0) + (qqqTopRecent ? 1 : 0) + (iwmTopRecent ? 1 : 0)

aggBottom = agreeBot >= minAgree
aggTop    = agreeTop >= minAgree

aggBottomEdge = aggBottom and not aggBottom[1]
aggTopEdge    = aggTop and not aggTop[1]

//========================
// Plot selection
//========================
tickerName = str.upper(syminfo.ticker)
isSpy = str.contains(tickerName, "SPY") or str.contains(tickerName, "SPX") or tickerName == "ES" or tickerName == "MES" or str.contains(tickerName, "ES1!")
isQqq = str.contains(tickerName, "QQQ") or str.contains(tickerName, "NDX") or tickerName == "NQ" or tickerName == "MNQ" or str.contains(tickerName, "NQ1!")
isIwm = str.contains(tickerName, "IWM") or str.contains(tickerName, "RUT") or str.contains(tickerName, "RTY") or tickerName == "M2K"

modePlot = plotMode == "AUTO" ? (isSpy ? "SPY" : isQqq ? "QQQ" : isIwm ? "IWM" : "AGG(å…±æŒ¯)") : plotMode
showSpy = modePlot == "SPY"
showQqq = modePlot == "QQQ"
showIwm = modePlot == "IWM"
showAgg = modePlot == "AGG(å…±æŒ¯)"

displayScore = showSpy ? spyScore : showQqq ? qqqScore : showIwm ? iwmScore : (spyScore + qqqScore + iwmScore) / 3
displayRsiS = showSpy ? spyRsiS : showQqq ? qqqRsiS : showIwm ? iwmRsiS : (spyRsiS + qqqRsiS + iwmRsiS) / 3
displayFiS = showSpy ? spyFiS : showQqq ? qqqFiS : showIwm ? iwmFiS : (spyFiS + qqqFiS + iwmFiS) / 3
displayTwS = showSpy ? spyTwS : showQqq ? qqqTwS : showIwm ? iwmTwS : (spyTwS + qqqTwS + iwmTwS) / 3
displayVolS = showSpy ? spyVolS : showQqq ? qqqVolS : showIwm ? iwmVolS : (spyVolS + qqqVolS + iwmVolS) / 3
displayAddS = showSpy ? spyAddS : showQqq ? qqqAddS : showIwm ? iwmAddS : (spyAddS + qqqAddS + iwmAddS) / 3

displayBullishDiv = showSpy ? spyBullishDiv : showQqq ? qqqBullishDiv : showIwm ? iwmBullishDiv : (spyBullishDiv or qqqBullishDiv or iwmBullishDiv)
displayBearishDiv = showSpy ? spyBearishDiv : showQqq ? qqqBearishDiv : showIwm ? iwmBearishDiv : (spyBearishDiv or qqqBearishDiv or iwmBearishDiv)

//========================
// Plot shapes
//========================
// SPY
plotshape(showSpy and spyBotTrig and spyStrongBot, title="SPY Panic Low", style=shape.labelup, location=location.belowbar, color=color.new(color.lime, 0), textcolor=color.black, size=size.normal, text="ğŸš€")
plotshape(showSpy and spyBotTrig and spyBot, title="SPY Buy Zone", style=shape.triangleup, location=location.belowbar, color=color.new(color.lime, 0), size=size.small, text="ğŸ“ˆ")
plotshape(showSpy and spyTopTrig and spyStrongTop, title="SPY Reduce", style=shape.labeldown, location=location.abovebar, color=color.new(color.red, 0), textcolor=color.white, size=size.normal, text="âš ï¸")
plotshape(showSpy and spyTopTrig and spyTop, title="SPY Caution", style=shape.triangledown, location=location.abovebar, color=color.new(color.orange, 0), size=size.small, text="âš¡")
plotshape(showSpy and spyElevated and not spyElevated[1], title="SPY Elevated", style=shape.diamond, location=location.abovebar, color=color.new(color.yellow, 0), size=size.tiny, text="â­")
plotshape(showSpy and spyBullishDiv and not spyBullishDiv[1], title="SPY Bullish Div", style=shape.labelup, location=location.belowbar, color=color.new(color.aqua, 0), textcolor=color.black, size=size.small, text="ğŸ’")
plotshape(showSpy and spyBearishDiv and not spyBearishDiv[1], title="SPY Bearish Div", style=shape.labeldown, location=location.abovebar, color=color.new(color.fuchsia, 0), textcolor=color.white, size=size.small, text="ğŸ’")

// QQQ
plotshape(showQqq and qqqBotTrig and qqqStrongBot, title="QQQ Panic Low", style=shape.labelup, location=location.belowbar, color=color.new(color.lime, 0), textcolor=color.black, size=size.normal, text="ğŸš€")
plotshape(showQqq and qqqBotTrig and qqqBot, title="QQQ Buy Zone", style=shape.triangleup, location=location.belowbar, color=color.new(color.lime, 0), size=size.small, text="ğŸ“ˆ")
plotshape(showQqq and qqqTopTrig and qqqStrongTop, title="QQQ Reduce", style=shape.labeldown, location=location.abovebar, color=color.new(color.red, 0), textcolor=color.white, size=size.normal, text="âš ï¸")
plotshape(showQqq and qqqTopTrig and qqqTop, title="QQQ Caution", style=shape.triangledown, location=location.abovebar, color=color.new(color.orange, 0), size=size.small, text="âš¡")
plotshape(showQqq and qqqElevated and not qqqElevated[1], title="QQQ Elevated", style=shape.diamond, location=location.abovebar, color=color.new(color.yellow, 0), size=size.tiny, text="â­")
plotshape(showQqq and qqqBullishDiv and not qqqBullishDiv[1], title="QQQ Bullish Div", style=shape.labelup, location=location.belowbar, color=color.new(color.aqua, 0), textcolor=color.black, size=size.small, text="ğŸ’")
plotshape(showQqq and qqqBearishDiv and not qqqBearishDiv[1], title="QQQ Bearish Div", style=shape.labeldown, location=location.abovebar, color=color.new(color.fuchsia, 0), textcolor=color.white, size=size.small, text="ğŸ’")

// IWM
plotshape(showIwm and iwmBotTrig and iwmStrongBot, title="IWM Panic Low", style=shape.labelup, location=location.belowbar, color=color.new(color.lime, 0), textcolor=color.black, size=size.normal, text="ğŸš€")
plotshape(showIwm and iwmBotTrig and iwmBot, title="IWM Buy Zone", style=shape.triangleup, location=location.belowbar, color=color.new(color.lime, 0), size=size.small, text="ğŸ“ˆ")
plotshape(showIwm and iwmTopTrig and iwmStrongTop, title="IWM Reduce", style=shape.labeldown, location=location.abovebar, color=color.new(color.red, 0), textcolor=color.white, size=size.normal, text="âš ï¸")
plotshape(showIwm and iwmTopTrig and iwmTop, title="IWM Caution", style=shape.triangledown, location=location.abovebar, color=color.new(color.orange, 0), size=size.small, text="âš¡")
plotshape(showIwm and iwmElevated and not iwmElevated[1], title="IWM Elevated", style=shape.diamond, location=location.abovebar, color=color.new(color.yellow, 0), size=size.tiny, text="â­")
plotshape(showIwm and iwmBullishDiv and not iwmBullishDiv[1], title="IWM Bullish Div", style=shape.labelup, location=location.belowbar, color=color.new(color.aqua, 0), textcolor=color.black, size=size.small, text="ğŸ’")
plotshape(showIwm and iwmBearishDiv and not iwmBearishDiv[1], title="IWM Bearish Div", style=shape.labeldown, location=location.abovebar, color=color.new(color.fuchsia, 0), textcolor=color.white, size=size.small, text="ğŸ’")

// AGG å…±æŒ¯
plotshape(showAgg and aggBottomEdge, title="Resonance Buy", style=shape.labelup, location=location.belowbar, color=color.new(color.lime, 0), textcolor=color.black, text="ğŸ”¥")
plotshape(showAgg and aggTopEdge, title="Resonance Risk", style=shape.labeldown, location=location.abovebar, color=color.new(color.red, 0), textcolor=color.white, text="â„ï¸")

//========================
// Dashboard
//========================
displayUptrend = showSpy ? spyUptrend : showQqq ? qqqUptrend : showIwm ? iwmUptrend : (spyUptrend and qqqUptrend) or (spyUptrend and iwmUptrend) or (qqqUptrend and iwmUptrend)
displayElevated = showSpy ? spyElevated : showQqq ? qqqElevated : showIwm ? iwmElevated : (spyElevated or qqqElevated or iwmElevated)

thresholdModeText = useAdaptive ? "Adaptive" : "Fixed"

if showDashboard and barstate.islast
    var table dashboard = table.new(position.top_right, 3, 10, bgcolor=color.new(color.black, 80), frame_color=color.gray, frame_width=1, border_color=color.gray, border_width=1)
    
    // Header
    table.cell(dashboard, 0, 0, "Factor", text_color=color.white, text_size=size.small)
    table.cell(dashboard, 1, 0, "Score", text_color=color.white, text_size=size.small)
    table.cell(dashboard, 2, 0, "Weight", text_color=color.white, text_size=size.small)
    
    // RSI
    rsiColor = displayRsiS > 0 ? color.lime : displayRsiS < 0 ? color.red : color.gray
    table.cell(dashboard, 0, 1, "RSI", text_color=color.white, text_size=size.small)
    table.cell(dashboard, 1, 1, str.tostring(displayRsiS, "#.#"), text_color=rsiColor, text_size=size.small)
    table.cell(dashboard, 2, 1, "1x", text_color=color.gray, text_size=size.small)
    
    // FI (50D) or ADD (Intraday)
    if intradayMode
        addColor = displayAddS > 0 ? color.lime : displayAddS < 0 ? color.red : color.gray
        table.cell(dashboard, 0, 2, "ADD", text_color=color.white, text_size=size.small)
        table.cell(dashboard, 1, 2, str.tostring(displayAddS, "#.#"), text_color=addColor, text_size=size.small)
        table.cell(dashboard, 2, 2, "Intraday", text_color=color.aqua, text_size=size.small)
    else
        fiColor = displayFiS > 0 ? color.lime : displayFiS < 0 ? color.red : color.gray
        table.cell(dashboard, 0, 2, "FI(50D)", text_color=color.white, text_size=size.small)
        table.cell(dashboard, 1, 2, str.tostring(displayFiS, "#.#"), text_color=fiColor, text_size=size.small)
        table.cell(dashboard, 2, 2, "Bottom", text_color=color.lime, text_size=size.small)
    
    // TW (20D)
    twColor = displayTwS > 0 ? color.lime : displayTwS < 0 ? color.red : color.gray
    table.cell(dashboard, 0, 3, "TW(20D)", text_color=color.white, text_size=size.small)
    table.cell(dashboard, 1, 3, str.tostring(displayTwS, "#.#"), text_color=twColor, text_size=size.small)
    table.cell(dashboard, 2, 3, "Top", text_color=color.red, text_size=size.small)
    
    // Volume
    volColor = displayVolS > 0 ? color.lime : displayVolS < 0 ? color.red : color.gray
    table.cell(dashboard, 0, 4, "Vol", text_color=color.white, text_size=size.small)
    table.cell(dashboard, 1, 4, str.tostring(displayVolS, "#.#"), text_color=volColor, text_size=size.small)
    table.cell(dashboard, 2, 4, "1x", text_color=color.gray, text_size=size.small)
    
    // Trend
    trendText = displayUptrend ? "â†‘ UP" : "â†“ DOWN"
    trendColor = displayUptrend ? color.lime : color.red
    table.cell(dashboard, 0, 5, "Trend", text_color=color.white, text_size=size.small)
    table.cell(dashboard, 1, 5, trendText, text_color=trendColor, text_size=size.small)
    table.cell(dashboard, 2, 5, str.tostring(trendMALen) + "MA", text_color=color.gray, text_size=size.small)
    
    // Threshold Mode
    thresholdColor = useAdaptive ? color.aqua : color.yellow
    table.cell(dashboard, 0, 6, "Mode", text_color=color.white, text_size=size.small)
    table.cell(dashboard, 1, 6, thresholdModeText, text_color=thresholdColor, text_size=size.small)
    table.cell(dashboard, 2, 6, "Vol=" + str.tostring(vol_fast, "#.#"), text_color=color.gray, text_size=size.small)
    
    // Divergence
    divText = displayBullishDiv ? "BULL ğŸ’" : displayBearishDiv ? "BEAR ğŸ’" : "-"
    divColor = displayBullishDiv ? color.aqua : displayBearishDiv ? color.fuchsia : color.gray
    table.cell(dashboard, 0, 7, "Div", text_color=color.white, text_size=size.small)
    table.cell(dashboard, 1, 7, divText, text_color=divColor, text_size=size.small)
    table.cell(dashboard, 2, 7, useDivergence ? "ON" : "OFF", text_color=useDivergence ? color.lime : color.gray, text_size=size.small)
    
    // Total
    totalColor = displayScore >= adjBotThreshold ? color.lime : displayScore <= adjTopThreshold ? (displayUptrend ? color.yellow : color.red) : color.gray
    table.cell(dashboard, 0, 8, "Total", text_color=color.white, text_size=size.normal)
    table.cell(dashboard, 1, 8, str.tostring(displayScore, "#.#"), text_color=totalColor, text_size=size.normal)
    signalText = displayScore >= adjStrongBotThreshold ? "PANIC LOW" : 
                 displayScore >= adjBotThreshold ? "ACCUMULATE" : 
                 displayElevated ? "ELEVATED" :
                 displayScore <= adjStrongTopThreshold ? "REDUCE" : 
                 displayScore <= adjTopThreshold ? "CAUTION" : 
                 "HOLD"
    table.cell(dashboard, 2, 8, signalText, text_color=totalColor, text_size=size.small)
    
    // Lookback Health (æ–°å¢)
    health_text = health_ok ? "âœ“ OK" : "âš  Check"
    health_color = health_ok ? color.lime : color.orange
    lookback_mode_display = lookbackMode == "Auto" ? "Auto" : lookbackMode == "Fixed 252" ? "252" : "Custom"
    table.cell(dashboard, 0, 9, "Lookback", text_color=color.white, text_size=size.small)
    table.cell(dashboard, 1, 9, str.tostring(adaptiveLookback), text_color=color.aqua, text_size=size.small)
    table.cell(dashboard, 2, 9, health_text, text_color=health_color, text_size=size.small)

//========================
// Alerts
//========================
autoBotTrig = (isSpy and spyBotTrig) or (isQqq and qqqBotTrig) or (isIwm and iwmBotTrig)
autoStrongBot = (isSpy and spyBotTrig and spyStrongBot) or (isQqq and qqqBotTrig and qqqStrongBot) or (isIwm and iwmBotTrig and iwmStrongBot)
autoTopTrig = (isSpy and spyTopTrig) or (isQqq and qqqTopTrig) or (isIwm and iwmTopTrig)
autoStrongTop = (isSpy and spyTopTrig and spyStrongTop) or (isQqq and qqqTopTrig and qqqStrongTop) or (isIwm and iwmTopTrig and iwmStrongTop)
autoBullishDiv = (isSpy and spyBullishDiv) or (isQqq and qqqBullishDiv) or (isIwm and iwmBullishDiv)
autoBearishDiv = (isSpy and spyBearishDiv) or (isQqq and qqqBearishDiv) or (isIwm and iwmBearishDiv)

alertcondition(autoStrongBot, title="ğŸš€ Panic Low", message="ğŸš€ Panic Low - Strong buy opportunity - {{ticker}} @ {{time}}")
alertcondition(autoBotTrig, title="ğŸ“ˆ Buy Zone", message="ğŸ“ˆ Buy Zone entry signal - {{ticker}} @ {{time}}")
alertcondition(autoStrongTop, title="âš ï¸ Reduce", message="âš ï¸ Reduce - High risk, consider reducing - {{ticker}} @ {{time}}")
alertcondition(autoTopTrig, title="âš¡ Caution", message="âš¡ Caution - Consider taking profits - {{ticker}} @ {{time}}")
alertcondition(aggBottomEdge, title="ğŸ”¥ Resonance Buy", message="ğŸ”¥ Multi-market resonance buy - {{ticker}} @ {{time}}")
alertcondition(aggTopEdge, title="â„ï¸ Resonance Risk", message="â„ï¸ Multi-market resonance risk - {{ticker}} @ {{time}}")
alertcondition(autoBullishDiv, title="ğŸ’ Bullish Divergence", message="ğŸ’ Bullish divergence detected - {{ticker}} @ {{time}}")
alertcondition(autoBearishDiv, title="ğŸ’ Bearish Divergence", message="ğŸ’ Bearish divergence detected - {{ticker}} @ {{time}}")
