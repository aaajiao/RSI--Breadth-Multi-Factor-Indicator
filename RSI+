//@version=6
indicator("RSI+Breadth Multi-Factor v7.0", overlay=true, max_labels_count=500, max_bars_back=1100)

//==============================================================================
// SIGNAL TERMINOLOGY & EMOJI REFERENCE ä¿¡å·æœ¯è¯­ä¸è¡¨æƒ…å‚è€ƒ
//==============================================================================
// Multi-factor scoring: RSI + Market Breadth (TW/FI) + Up/Down Volume + Divergence
// å¤šå› å­è¯„åˆ†ç³»ç»Ÿï¼šRSI + å¸‚åœºå¹¿åº¦ (TW/FI) + ä¸Šæ¶¨/ä¸‹è·Œæˆäº¤é‡ + èƒŒç¦»
//
// SIGNAL LEVELS ä¿¡å·çº§åˆ«:
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ Score â”‚ Emoji â”‚ Signal      â”‚ ä¸­æ–‡     â”‚ Action æ“ä½œå»ºè®®                  â”‚
// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
// â”‚ >= 6  â”‚ ğŸš€    â”‚ PANIC LOW   â”‚ ææ…Œä½ç‚¹ â”‚ Strong buy å¼ºçƒˆä¹°å…¥              â”‚
// â”‚ >= 4  â”‚ ğŸ“ˆ    â”‚ BUY ZONE    â”‚ ä½å¸åŒº   â”‚ Accumulate åˆ†æ‰¹å»ºä»“              â”‚
// â”‚ -3~3  â”‚ -     â”‚ HOLD        â”‚ æŒæœ‰     â”‚ Hold position æŒä»“è§‚æœ›           â”‚
// â”‚ <=-4â†‘ â”‚ â­    â”‚ ELEVATED    â”‚ é«˜ä¼°     â”‚ Hold cautious æŒæœ‰ä½†è°¨æ…         â”‚
// â”‚ <=-4â†“ â”‚ âš¡    â”‚ CAUTION     â”‚ è§‚æœ›     â”‚ Take profit æ­¢ç›ˆ                 â”‚
// â”‚ <=-6â†“ â”‚ âš ï¸    â”‚ REDUCE      â”‚ å‡ä»“     â”‚ Reduce position å‡å°‘ä»“ä½         â”‚
// â”‚  DIV  â”‚ ğŸ’    â”‚ DIVERGENCE  â”‚ èƒŒç¦»     â”‚ Reversal confirmation åè½¬ç¡®è®¤   â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
// â†‘ = Uptrend ä¸Šå‡è¶‹åŠ¿ (price > MA)  â†“ = Downtrend ä¸‹é™è¶‹åŠ¿ (price < MA)
//
// RESONANCE å…±æŒ¯ä¿¡å·:
// ğŸ”¥ Resonance Buy  å…±æŒ¯ä¹°å…¥ - Multiple markets in buy zone å¤šå¸‚åœºåŒæ—¶ä½å¸
// â„ï¸ Resonance Risk å…±æŒ¯é£é™© - Multiple markets in risk zone å¤šå¸‚åœºåŒæ—¶é«˜ä¼°
//
// v7.0 ENHANCEMENTS å¢å¼ºåŠŸèƒ½:
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ Feature         â”‚ Effect                â”‚ æ•ˆæœè¯´æ˜                        â”‚
// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
// â”‚ Quality Filter  â”‚ A/B grade only        â”‚ ä»…è§¦å‘A/Bçº§(2+å› å­åŒå‘)ä¿¡å·     â”‚
// â”‚ Drawdown Bonus  â”‚ +1/+2/+3 at 5/10/20%  â”‚ å›æ’¤5/10/20%æ—¶åŠ åˆ†+1/+2/+3     â”‚
// â”‚ Divergence Assistâ”‚ Edge signal boost    â”‚ è¾¹ç¼˜ä¿¡å·(å·®1-2åˆ†)å¯è¢«èƒŒç¦»è§¦å‘   â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
//==============================================================================

//========================
// Mode (è¯„åˆ†é˜ˆå€¼è°ƒæ•´)
//========================
grpMode = "Mode / æ¨¡å¼"
mode = input.string("Standard", "Signal Mode ä¿¡å·æ¨¡å¼", options=["Aggressive","Standard","Conservative"], group=grpMode, tooltip="Aggressive: æ›´çµæ• More sensitive\nStandard: å¹³è¡¡ Balanced\nConservative: æ›´ä¿å®ˆ More conservative")

//========================
// Adaptive Settings (è‡ªé€‚åº”è®¾ç½®)
//========================
grpAdaptive = "Adaptive / è‡ªé€‚åº”"

// Lookback æ¨¡å¼é€‰æ‹©
lookbackMode = input.string("Auto", "Lookback Mode å›æº¯æ¨¡å¼", options=["Auto", "Fixed 252", "Custom"], group=grpAdaptive, tooltip="Auto: è‡ªåŠ¨è®¡ç®— Auto calculate\nFixed 252: å›ºå®š1å¹´ Fixed 1 year\nCustom: è‡ªå®šä¹‰ Custom value")
lookbackCustom = input.int(252, "Custom Lookback è‡ªå®šä¹‰å›æº¯", minval=100, maxval=1000, group=grpAdaptive)

// ç²¾åº¦æ§åˆ¶ï¼ˆå¤§ç›˜æŒ‡æ•°ä¼˜åŒ–ä¸º High é»˜è®¤ï¼‰
lookbackPrecision = input.string("High", "Precision ç²¾åº¦", options=["High", "Normal", "Low"], group=grpAdaptive, tooltip="High: æ›´ç²¾ç¡® More precise\nNormal: å¹³è¡¡ Balanced\nLow: æ›´å¿« Faster")

// é•¿æœŸæ³¢åŠ¨å†å²æ·±åº¦
volHistoryMode = input.string("1 Year", "Vol History æ³¢åŠ¨å†å²", options=["6 Months", "1 Year", "2 Years"], group=grpAdaptive, tooltip="æ³¢åŠ¨ç‡å†å²å‘¨æœŸ Volatility history period")

// Threshold Mode
thresholdMode = input.string("Auto", "Threshold Mode é˜ˆå€¼æ¨¡å¼", options=["Auto", "Fixed", "Adaptive"], group=grpAdaptive, tooltip="Auto: è‡ªåŠ¨é€‰æ‹© Auto select\nFixed: å›ºå®šé˜ˆå€¼ Fixed values\nAdaptive: åŠ¨æ€é˜ˆå€¼ Dynamic percentile")

// RSI æ³¢åŠ¨é˜ˆå€¼ï¼ˆå¤§ç›˜æŒ‡æ•°ä¼˜åŒ–ä¸º 8.0ï¼‰
rsiVolThreshold = input.float(8.0, "RSI Vol Threshold RSIæ³¢åŠ¨é˜ˆå€¼", minval=5.0, maxval=20.0, group=grpAdaptive, tooltip="Autoæ¨¡å¼è§¦å‘å€¼ Trigger for Auto mode\næŒ‡æ•°8.0 / ä¸ªè‚¡10.0 Index 8.0 / Stock 10.0")

//========================
// Core Inputs
//========================
grp1 = "Core Settings æ ¸å¿ƒè®¾ç½®"
rsiLen = input.int(14, "RSI Length RSIå‘¨æœŸ", minval=2, group=grp1)

// è‡ªåŠ¨è·å–å›¾è¡¨å‘¨æœŸ
tfData = timeframe.period
intradayMode = timeframe.isintraday

//========================
// Fixed Thresholds (å›ºå®šé˜ˆå€¼ - å¯é…ç½®)
//========================
grpFixedThresh = "Fixed Thresholds å›ºå®šé˜ˆå€¼"
fixedRsiOversold1 = input.int(30, "Oversold Lv1 è¶…å–1", minval=10, maxval=40, group=grpFixedThresh)
fixedRsiOversold2 = input.int(40, "Oversold Lv2 è¶…å–2", minval=20, maxval=50, group=grpFixedThresh)
fixedRsiOverbought1 = input.int(75, "Overbought Lv1 è¶…ä¹°1", minval=60, maxval=90, group=grpFixedThresh)
fixedRsiOverbought2 = input.int(65, "Overbought Lv2 è¶…ä¹°2", minval=50, maxval=80, group=grpFixedThresh)

grp2 = "Signal Thresholds ä¿¡å·é˜ˆå€¼ (%)"

buyThresholdPct = input.int(50, "Buy Sensitivity ä¹°å…¥çµæ•åº¦ %", 
    minval=25, maxval=75, step=5, group=grp2,
    tooltip="æ§åˆ¶ä¹°å…¥ä¿¡å·è§¦å‘éš¾åº¦\n50%=å¹³è¡¡ | <50%=æ›´ä¸¥æ ¼ | >50%=æ›´çµæ•\n" +
            "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n" +
            "ğŸ“ˆ Buy Zone = æ­¤å€¼\nğŸš€ Panic Low = æ­¤å€¼ + 25%\n" +
            "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n" +
            "Buy signal sensitivity\n50%=Balanced | <50%=Stricter | >50%=Sensitive")

sellThresholdPct = input.int(45, "Sell Sensitivity å–å‡ºçµæ•åº¦ %", 
    minval=25, maxval=75, step=5, group=grp2,
    tooltip="æ§åˆ¶å–å‡ºä¿¡å·è§¦å‘éš¾åº¦\n45%=å¹³è¡¡ | <45%=æ›´ä¸¥æ ¼ | >45%=æ›´çµæ•\n" +
            "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n" +
            "âš¡ Caution = æ­¤å€¼\nâš ï¸ Reduce = æ­¤å€¼ + 25%\n" +
            "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n" +
            "Sell signal sensitivity\n45%=Balanced | <45%=Stricter | >45%=Sensitive")

// å›ºå®šåç§»é‡ï¼šå¼ºä¿¡å·æ¯”å¼±ä¿¡å·é«˜25%
// Fixed offset: strong signal is 25% higher than weak signal
strongOffset = 25

// ç†è®ºæœ€å¤§åˆ†æ•°ï¼ˆåŸºäºè¯„åˆ†å‡½æ•°ï¼‰
// Theoretical max scores (based on scoring functions)
maxBuyScore = 8   // RSI(+2) + FI(+3) + TW(+1) + Vol(+2)
maxSellScore = 9  // RSI(-2) + FI(-2) + TW(-3) + Vol(-2)

// åŠ¨æ€è®¡ç®—é˜ˆå€¼ / Dynamically calculate thresholds
botThreshold = int(maxBuyScore * buyThresholdPct / 100)
strongBotThreshold = int(maxBuyScore * (buyThresholdPct + strongOffset) / 100)
topThreshold = -int(maxSellScore * sellThresholdPct / 100)
strongTopThreshold = -int(maxSellScore * (sellThresholdPct + strongOffset) / 100)

grp3 = "Signal Logic ä¿¡å·é€»è¾‘"
cooldownIn = input.int(10, "Cooldown Bars å†·å´å‘¨æœŸ", minval=0, group=grp3, tooltip="ä¿¡å·é—´éš”Kçº¿æ•° Bars between signals")
useDynamicCooldown = input.bool(true, "Dynamic Cooldown åŠ¨æ€å†·å´", group=grp3, tooltip="æ ¹æ®æ³¢åŠ¨ç‡è‡ªåŠ¨è°ƒæ•´å†·å´æœŸ\nAuto-adjust cooldown based on volatility\né«˜æ³¢åŠ¨=çŸ­å†·å´ | ä½æ³¢åŠ¨=é•¿å†·å´")
confirmBars = input.int(3, "Resonance Window å…±æŒ¯çª—å£", minval=0, group=grp3, tooltip="å…±æŒ¯æ£€æµ‹èŒƒå›´ Resonance window bars")
minAgree = input.int(2, "Min Markets æœ€å°å¸‚åœºæ•°", minval=1, maxval=3, group=grp3, tooltip="è§¦å‘å…±æŒ¯æ‰€éœ€å¸‚åœºæ•° Markets needed for resonance")

//========================
// v7.0 Optimizations (èƒœç‡ä¼˜åŒ–)
//========================
grpOptimize = "v7.0 Optimizations èƒœç‡ä¼˜åŒ–"
useSignalQuality = input.bool(true, "Signal Quality Filter ä¿¡å·è´¨é‡è¿‡æ»¤", group=grpOptimize,
    tooltip="ä»…è§¦å‘A/Bçº§ä¿¡å·(å¤šå› å­åŒå‘)\nOnly trigger A/B grade signals (multi-factor aligned)\nAçº§=3+å› å­åŒå‘ | Bçº§=2å› å­åŒå‘ | Cçº§=è¿‡æ»¤")
useDrawdownBonus = input.bool(true, "Drawdown Bonus å›æ’¤åŠ åˆ†", group=grpOptimize,
    tooltip="æŒ‡æ•°å›æ’¤æ—¶å¢åŠ ä¹°å…¥è¯„åˆ†\nAdd bonus score when index is in drawdown\n>5%=+1 | >10%=+2 | >20%=+3")
useDivergenceAssist = input.bool(true, "Divergence Assist èƒŒç¦»åŠ©æ¨", group=grpOptimize,
    tooltip="èƒŒç¦»å¯åŠ©æ¨è¾¹ç¼˜ä¿¡å·(å·®1-2åˆ†)\nDivergence can boost edge signals\nè¯„åˆ†æ¥è¿‘é˜ˆå€¼æ—¶ï¼ŒèƒŒç¦»å¯è§¦å‘ä¿¡å·")

//========================
// Divergence Settings (èƒŒç¦»è®¾ç½®)
//========================
grpDiv = "Divergence èƒŒç¦»"
useDivergence = input.bool(true, "Enable Divergence å¯ç”¨èƒŒç¦»", group=grpDiv)
divZScoreThreshold = input.float(1.7, "Divergence Threshold èƒŒç¦»é˜ˆå€¼", minval=0.5, maxval=3.0, step=0.1, group=grpDiv, tooltip="èƒŒç¦»æ£€æµ‹å¼ºåº¦ Divergence strength\nå¹³è¡¡1.7 / é«˜è´¨é‡2.0 / çµæ•1.5 Balanced/Quality/Sensitive")
divCooldownBars = input.int(5, "Divergence Cooldown èƒŒç¦»å†·å´", minval=0, maxval=30, group=grpDiv, tooltip="èƒŒç¦»é—´éš”Kçº¿æ•° Bars between divergences\næ¨è5-10 Recommended 5-10")

//========================
// Trend Filter (è¶‹åŠ¿è¿‡æ»¤)
//========================
grp3b = "Trend Filter è¶‹åŠ¿è¿‡æ»¤"
trendMALen = input.int(10, "Trend MA Length è¶‹åŠ¿å‡çº¿", minval=5, maxval=50, group=grp3b)
useTrendFilter = input.bool(true, "Enable Trend Filter å¯ç”¨è¶‹åŠ¿è¿‡æ»¤", group=grp3b)

//========================
// Symbols
//========================
grp5 = "Symbols / æ ‡çš„"
spySym = input.symbol("AMEX:SPY", "SPY", group=grp5)
qqqSym = input.symbol("NASDAQ:QQQ", "QQQ", group=grp5)
iwmSym = input.symbol("AMEX:IWM", "Russell2000 (IWM)", group=grp5)

s5twSym = input.symbol("INDEX:S5TW", "S5TW (% > 20D MA)", group=grp5)
s5fiSym = input.symbol("INDEX:S5FI", "S5FI (% > 50D MA)", group=grp5)
nctwSym = input.symbol("INDEX:NCTW", "NCTW (% > 20D MA)", group=grp5)
ncfiSym = input.symbol("INDEX:NCFI", "NCFI (% > 50D MA)", group=grp5)
r2twSym = input.symbol("INDEX:R2TW", "R2TW (% > 20D MA)", group=grp5)
r2fiSym = input.symbol("INDEX:R2FI", "R2FI (% > 50D MA)", group=grp5)

grp5b = "Volume Breadth æˆäº¤é‡å¹¿åº¦"
uvolSym = input.symbol("USI:UVOL", "Up Volume ä¸Šæ¶¨é‡ (NYSE)", group=grp5b)
dvolSym = input.symbol("USI:DVOL", "Down Volume ä¸‹è·Œé‡ (NYSE)", group=grp5b)
uvolqSym = input.symbol("USI:UVOLQ", "Up Volume ä¸Šæ¶¨é‡ (NASDAQ)", group=grp5b)
dvolqSym = input.symbol("USI:DVOLQ", "Down Volume ä¸‹è·Œé‡ (NASDAQ)", group=grp5b)
addSym = input.symbol("USI:ADD", "Advance-Decline æ¶¨è·Œå·®", group=grp5b, tooltip="æ—¥å†…æ¨¡å¼å¹¿åº¦ Intraday breadth")

grp6 = "Plot æ˜¾ç¤º"
plotMode = input.string("AUTO", "Display Mode æ˜¾ç¤ºæ¨¡å¼", options=["AUTO","SPY","QQQ","IWM","AGG(å…±æŒ¯)"], group=grp6)
showDashboard = input.bool(true, "Show Dashboard æ˜¾ç¤ºé¢æ¿", group=grp6)

// Dashboard Customization é¢æ¿è‡ªå®šä¹‰
dashboardMode = input.string("Full", "Dashboard Mode é¢æ¿æ¨¡å¼", 
    options=["Full", "Mobile"], group=grp6,
    tooltip="Full: å®Œæ•´11è¡Œè¯¦æƒ… | Mobile: ç²¾ç®€3è¡Œæ ¸å¿ƒä¿¡æ¯\nFull: 11 rows detail | Mobile: 3 rows essential")

dashboardPosition = input.string("Top Right", "Panel Position é¢æ¿ä½ç½®", 
    options=["Top Left", "Top Right", "Bottom Left", "Bottom Right", 
             "Middle Left", "Middle Right"], group=grp6,
    tooltip="é¢æ¿æ˜¾ç¤ºä½ç½® Dashboard location on chart")

dashboardFontSize = input.string("Small", "Font Size å­—ä½“å¤§å°",
    options=["Tiny", "Small", "Normal", "Large"], group=grp6,
    tooltip="Tiny: æœ€å° | Small: é»˜è®¤ | Normal: ä¸­ç­‰ | Large: æœ€å¤§")

showSignalZone = input.bool(true, "Show Signal Zone æ˜¾ç¤ºä¿¡å·åŒºé—´", group=grp6,
    tooltip="ä¿¡å·è§¦å‘åèƒŒæ™¯é«˜äº®ç›´åˆ°å›å½’HOLD\nHighlight background from signal trigger until back to HOLD\nç»¿è‰²=ä¹°å…¥åŒºé—´ | çº¢è‰²=å–å‡ºåŒºé—´")

//========================
// Mode presets
//========================
modeAdjust = mode == "Aggressive" ? 1 : mode == "Conservative" ? -1 : 0
intradayAdjust = intradayMode ? 2 : 0
adjBotThreshold = botThreshold - modeAdjust - intradayAdjust
adjStrongBotThreshold = strongBotThreshold - modeAdjust - intradayAdjust
adjTopThreshold = topThreshold + modeAdjust + intradayAdjust
adjStrongTopThreshold = strongTopThreshold + modeAdjust + intradayAdjust
cooldownBarsBase = mode == "Aggressive" ? 5 : mode == "Conservative" ? 15 : cooldownIn

//========================
// Helpers
//========================
f_sec(_sym, _expr) =>
    request.security(_sym, tfData, _expr, barmerge.gaps_off, barmerge.lookahead_off)

f_ohlc(_sym) =>
    request.security(_sym, tfData, [open, high, low, close], barmerge.gaps_off, barmerge.lookahead_off)

f_secDaily(_sym, _expr) =>
    request.security(_sym, "D", _expr, barmerge.gaps_off, barmerge.lookahead_off)

f_rsi_from_close(_c) =>
    ta.rsi(_c, rsiLen)

f_recent(_cond, _bars) =>
    if _bars == 0
        _cond
    else
        bs = ta.barssince(_cond)
        not na(bs) and bs <= _bars

f_applyCooldown(_rawSig, _coolBars, _lastBar) =>
    can = na(_lastBar) or (bar_index - _lastBar > _coolBars)
    _rawSig and (_coolBars == 0 or can)

// Dynamic Cooldown Function (åŠ¨æ€å†·å´è®¡ç®—)
// High volatility â†’ shorter cooldown (market moves fast, need quick response)
// Low volatility â†’ longer cooldown (market calm, avoid noise signals)
f_dynamicCooldown(_baseCooldown, _volFast, _volThreshold) =>
    volRatio = _volFast / _volThreshold
    // é«˜æ³¢åŠ¨ (>1.2x): 60% å†·å´ | æ­£å¸¸: 100% | ä½æ³¢åŠ¨ (<0.8x): 150% å†·å´
    adjustedCooldown = volRatio > 1.2 ? int(_baseCooldown * 0.6) :
                       volRatio < 0.8 ? int(_baseCooldown * 1.5) :
                       _baseCooldown
    math.max(3, adjustedCooldown)  // æœ€å°3æ ¹Kçº¿

//========================
// v7.0 Optimization Functions (èƒœç‡ä¼˜åŒ–å‡½æ•°)
//========================

// Signal Quality Assessment (ä¿¡å·è´¨é‡è¯„ä¼°)
// Açº§: 3+å› å­åŒå‘ = é«˜è´¨é‡ | Bçº§: 2å› å­åŒå‘ = æ ‡å‡† | Cçº§: <2å› å­ = è¿‡æ»¤
f_signalQuality(_rsiS, _fiS, _twS, _volS, _addS, _intraday) =>
    positiveFactors = 0
    negativeFactors = 0

    // è®¡ç®—æ­£å‘å› å­æ•°é‡ (ä¹°å…¥æ–¹å‘)
    positiveFactors := (_rsiS > 0 ? 1 : 0) + (_volS > 0 ? 1 : 0)
    if _intraday
        positiveFactors := positiveFactors + (_addS > 0 ? 1 : 0)
    else
        positiveFactors := positiveFactors + (_fiS > 0 ? 1 : 0) + (_twS > 0 ? 1 : 0)

    // è®¡ç®—è´Ÿå‘å› å­æ•°é‡ (å–å‡ºæ–¹å‘)
    negativeFactors := (_rsiS < 0 ? 1 : 0) + (_volS < 0 ? 1 : 0)
    if _intraday
        negativeFactors := negativeFactors + (_addS < 0 ? 1 : 0)
    else
        negativeFactors := negativeFactors + (_fiS < 0 ? 1 : 0) + (_twS < 0 ? 1 : 0)

    // ä¿¡å·è´¨é‡ç­‰çº§
    maxFactors = _intraday ? 3 : 4
    buyQuality = positiveFactors >= 3 ? "A" : positiveFactors >= 2 ? "B" : "C"
    sellQuality = negativeFactors >= 3 ? "A" : negativeFactors >= 2 ? "B" : "C"

    [buyQuality, sellQuality, positiveFactors, negativeFactors]

// Drawdown Bonus (å›æ’¤åŠ åˆ† - é’ˆå¯¹æŒ‡æ•°é•¿æœŸå‘ä¸Šç‰¹æ€§)
// åˆ©ç”¨"ä¸‹è·Œ=ä¹°å…¥æœºä¼š"çš„æŒ‡æ•°ç‰¹æ€§
f_drawdownBonus(_close, _high252) =>
    drawdown = _high252 > 0 ? (_high252 - _close) / _high252 * 100 : 0.0

    bonus = 0.0
    if drawdown >= 20      // æŠ€æœ¯æ€§ç†Šå¸‚
        bonus := 3.0
    else if drawdown >= 10 // æ˜¾è‘—å›è°ƒ
        bonus := 2.0
    else if drawdown >= 5  // å°å¹…å›æ’¤
        bonus := 1.0
    [bonus, drawdown]

// Divergence Assisted Signal (èƒŒç¦»åŠ©æ¨æœºåˆ¶)
// å½“è¯„åˆ†æ¥è¿‘é˜ˆå€¼(å·®1-2åˆ†)ä½†æœªè¾¾åˆ°æ—¶ï¼ŒèƒŒç¦»å¯ä»¥åŠ©æ¨è§¦å‘
f_divergenceAssisted(_score, _threshold, _hasDivergence, _assistEnabled) =>
    if not _assistEnabled
        _score >= _threshold
    else
        // è¯„åˆ†è¾¾é˜ˆå€¼ â†’ æ­£å¸¸è§¦å‘
        if _score >= _threshold
            true
        // è¯„åˆ†æ¥è¿‘é˜ˆå€¼(å·®1-2åˆ†) + æœ‰èƒŒç¦» â†’ åŠ©æ¨è§¦å‘
        else if _score >= (_threshold - 2) and _hasDivergence
            true
        else
            false

// Tiered Resonance System (åˆ†çº§å…±æŒ¯ç³»ç»Ÿ)
// åŒæ­¥å…±æŒ¯(åŒä¸€Kçº¿) > çª—å£å…±æŒ¯ > å•å¸‚åœº
f_resonanceStrength(_spyTrig, _qqqTrig, _iwmTrig, _spyRecent, _qqqRecent, _iwmRecent) =>
    // åŒæ­¥å…±æŒ¯: åŒä¸€æ ¹Kçº¿è§¦å‘ (æœ€é«˜è´¨é‡)
    syncCount = (_spyTrig ? 1 : 0) + (_qqqTrig ? 1 : 0) + (_iwmTrig ? 1 : 0)
    syncResonance = syncCount >= 2

    // çª—å£å…±æŒ¯: çª—å£æœŸå†…è§¦å‘
    windowCount = (_spyRecent ? 1 : 0) + (_qqqRecent ? 1 : 0) + (_iwmRecent ? 1 : 0)

    // å…±æŒ¯å¼ºåº¦: 3=å®Œç¾å…±æŒ¯(3å¸‚åœºåŒæ­¥), 2.5=åŒåŒæ­¥, 2=çª—å£å…±æŒ¯, 1=å•å¸‚åœº
    strength = syncCount >= 3 ? 3.0 :
               syncResonance ? 2.5 :
               windowCount >= 2 ? 2.0 :
               windowCount >= 1 ? 1.0 : 0.0

    // å…±æŒ¯åŠ åˆ†
    bonus = strength >= 2.5 ? 1.0 : strength >= 2 ? 0.5 : 0.0

    [strength, bonus, syncResonance, syncCount, windowCount]

//========================
// Adaptive Threshold Calculation (è‡ªé€‚åº”é˜ˆå€¼è®¡ç®—)
//========================
f_adaptiveThresholds(_rsi, _lookback) =>
    // å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿ lookback ä¸è¶…è¿‡å¯ç”¨çš„å†å²æ•°æ®
    // Pine Script çš„ percentile å‡½æ•°éœ€è¦è‡³å°‘ lookback+1 æ ¹ bar
    // åŒæ—¶ç¡®ä¿æœ€å°å€¼ä¸º 10ï¼Œä¿è¯ç™¾åˆ†ä½è®¡ç®—æœ‰æ„ä¹‰
    safe_lookback = math.max(10, math.min(_lookback, bar_index - 1))
    
    oversold1 = ta.percentile_linear_interpolation(_rsi, safe_lookback, 10)
    oversold2 = ta.percentile_linear_interpolation(_rsi, safe_lookback, 20)
    overbought1 = ta.percentile_linear_interpolation(_rsi, safe_lookback, 90)
    overbought2 = ta.percentile_linear_interpolation(_rsi, safe_lookback, 80)
    [oversold1, oversold2, overbought1, overbought2]

//========================
// Scoring Functions (è¯„åˆ†å‡½æ•°)
//========================
f_rsiScore(_rsi, _oversold1, _oversold2, _overbought1, _overbought2) =>
    score = 0.0
    if not na(_rsi)
        if _rsi < _oversold1
            score := 2
        else if _rsi < _oversold2
            score := 1
        else if _rsi > _overbought1
            score := -2
        else if _rsi > _overbought2
            score := -1
    score

f_fiScore(_fi) =>
    score = 0.0
    if not na(_fi)
        if _fi < 25
            score := 3
        else if _fi < 35
            score := 2
        else if _fi < 45
            score := 1
        else if _fi > 85
            score := -2
        else if _fi > 78
            score := -1
    score

f_twScore(_tw) =>
    score = 0.0
    if not na(_tw)
        if _tw > 82
            score := -3
        else if _tw > 72
            score := -2
        else if _tw > 68
            score := -1
        else if _tw < 30
            score := 1
    score

f_volScore(_uvol, _dvol) =>
    score = 0.0
    if not na(_uvol) and not na(_dvol) and _dvol > 0
        ratio = _uvol / _dvol
        if ratio < 0.5
            score := 2
        else if ratio < 0.8
            score := 1
        else if ratio > 2.5
            score := -2
        else if ratio > 1.8
            score := -1
    score

// æ—¥å†…å¹¿åº¦è¯„åˆ† (ä½¿ç”¨ ADD)
f_addScore(_add) =>
    score = 0.0
    if not na(_add)
        if _add < -1500
            score := 3
        else if _add < -500
            score := 2
        else if _add < 0
            score := 1
        else if _add > 1500
            score := -3
        else if _add > 500
            score := -2
        else if _add > 0
            score := -1
    score

//========================
// Divergence Detection (èƒŒç¦»æ£€æµ‹)
//========================
f_divergence(_close, _rsi, _lookback) =>
    priceMA = ta.sma(_close, _lookback)
    priceStd = ta.stdev(_close, _lookback)
    rsiMA = ta.sma(_rsi, _lookback)
    rsiStd = ta.stdev(_rsi, _lookback)
    
    priceZ = priceStd > 0 ? (_close - priceMA) / priceStd : 0
    rsiZ = rsiStd > 0 ? (_rsi - rsiMA) / rsiStd : 0
    
    divStrength = priceZ - rsiZ
    [divStrength, priceZ, rsiZ]

//========================
// Total Score Function (ç»¼åˆè¯„åˆ†)
//========================
f_totalScore(_rsi, _tw, _fi, _uvol, _dvol, _add, _intraday, _oversold1, _oversold2, _overbought1, _overbought2) =>
    rsiS = f_rsiScore(_rsi, _oversold1, _oversold2, _overbought1, _overbought2)
    volS = f_volScore(_uvol, _dvol)
    
    fiS = 0.0
    twS = 0.0
    addS = 0.0
    
    if _intraday
        addS := f_addScore(_add)
    else
        fiS := f_fiScore(_fi)
        twS := f_twScore(_tw)
    
    total = rsiS + fiS + twS + volS + addS
    [total, rsiS, fiS, twS, volS, addS]

//========================
// Signal Generation Function (ä¿¡å·ç”Ÿæˆ - æ¨¡å—åŒ–)
//========================
f_generateSignals(_score, _uptrend, _adjBotTh, _adjStrongBotTh, _adjTopTh, _adjStrongTopTh) =>
    strongBot = _score >= _adjStrongBotTh
    bot = _score >= _adjBotTh and _score < _adjStrongBotTh
    topCond = _score <= _adjTopTh and _score > _adjStrongTopTh
    strongTopCond = _score <= _adjStrongTopTh
    top = topCond and (not useTrendFilter or not _uptrend)
    strongTop = strongTopCond and (not useTrendFilter or not _uptrend)
    elevated = (topCond or strongTopCond) and _uptrend and useTrendFilter
    [strongBot, bot, top, strongTop, elevated, strongBot or bot, strongTop or top]

//========================
// Market data
//========================
[spyO, spyH, spyL, spyC] = f_ohlc(spySym)
[qqqO, qqqH, qqqL, qqqC] = f_ohlc(qqqSym)
[iwmO, iwmH, iwmL, iwmC] = f_ohlc(iwmSym)

spyRSI = f_rsi_from_close(spyC)
qqqRSI = f_rsi_from_close(qqqC)
iwmRSI = f_rsi_from_close(iwmC)

s5tw = f_secDaily(s5twSym, close)
s5fi = f_secDaily(s5fiSym, close)
nctw = f_secDaily(nctwSym, close)
ncfi = f_secDaily(ncfiSym, close)
r2tw = f_secDaily(r2twSym, close)
r2fi = f_secDaily(r2fiSym, close)

uvol = f_secDaily(uvolSym, close)
dvol = f_secDaily(dvolSym, close)
uvolq = f_secDaily(uvolqSym, close)
dvolq = f_secDaily(dvolqSym, close)

// Intraday breadth proxy
addValue = f_sec(addSym, close)

//========================
// Dual Volatility System & Auto-Adaptive Lookback (åŒé‡æ³¢åŠ¨ç‡ç³»ç»Ÿ)
//========================

// Step 1: çŸ­æœŸæ³¢åŠ¨ï¼ˆè‡ªé€‚åº”åˆ° RSI é•¿åº¦ï¼‰
vol_short_period = rsiLen * 4
vol_short = ta.stdev(spyRSI, vol_short_period)

// Step 2: é•¿æœŸæ³¢åŠ¨ï¼ˆæ ¹æ®ç”¨æˆ·é€‰æ‹©çš„å†å²æ·±åº¦ï¼‰
vol_history_days = volHistoryMode == "6 Months" ? 126 : volHistoryMode == "1 Year" ? 252 : 504

// æ ¹æ®æ—¶é—´æ¡†æ¶è°ƒæ•´ï¼ˆç¡®ä¿è¦†ç›–ç›¸åŒå¤©æ•°ï¼‰
tf_minutes = timeframe.in_seconds(timeframe.period) / 60
bars_per_day = timeframe.isdaily or timeframe.isweekly or timeframe.ismonthly ? 1 : math.ceil(1440 / tf_minutes)
vol_long_period = math.min(1000, vol_history_days * bars_per_day)
vol_long = ta.stdev(spyRSI, vol_long_period)

// Step 3: åŠ¨æ€åŠ æƒç»„åˆ
// åŸºç¡€ï¼š70% é•¿æœŸ + 30% çŸ­æœŸï¼ˆåå‘ç¨³å®šï¼‰
vol_base = vol_long * 0.7 + vol_short * 0.3

// å¦‚æœè¿‘æœŸæ³¢åŠ¨æ˜¾è‘—é«˜äºé•¿æœŸï¼ˆ> 1.2å€ï¼‰ï¼Œåˆ‡æ¢åˆ°çŸ­æœŸä¸»å¯¼
recent_high = vol_short > vol_long * 1.2
vol_dynamic = recent_high ? (vol_short * 0.6 + vol_long * 0.4) : vol_base

// ä¿å®ˆä¸‹é™ï¼šä¸ä½äºé•¿æœŸæ³¢åŠ¨çš„ 80%
vol_final = math.max(vol_dynamic, vol_long * 0.8)

// Step 4: ç»Ÿè®¡å…¬å¼è®¡ç®— Lookback
// n = (Z Ã— Ïƒ / E)Â²  å…¶ä¸­ Z=1.96 (95%ç½®ä¿¡åº¦)
stat_error = lookbackPrecision == "High" ? 2.0 : lookbackPrecision == "Normal" ? 2.5 : 3.5
stat_required = math.pow(1.96 * vol_final / stat_error, 2)
auto_lookback = int(math.max(100, math.min(1000, stat_required)))

// Step 5: åº”ç”¨æ¨¡å¼é€‰æ‹©
adaptiveLookback_raw = lookbackMode == "Custom" ? lookbackCustom : 
                       lookbackMode == "Fixed 252" ? 252 : auto_lookback

// Step 6: å®‰å…¨é™åˆ¶ - ç¡®ä¿ä¸è¶…è¿‡å¯ç”¨å†å²æ•°æ®
// åœ¨å›¾è¡¨æ—©æœŸï¼Œbar_index å¯èƒ½å°äºè®¡ç®—å‡ºçš„ lookback
adaptiveLookback = int(math.min(adaptiveLookback_raw, bar_index))

// Step 7: å¥åº·åº¦æŒ‡æ ‡ï¼ˆå¤§ç›˜æŒ‡æ•°ä¼˜åŒ–ï¼šåˆ†å¸ƒå®½åº¦é˜ˆå€¼ 12ï¼‰
health_sample_coverage = bar_index >= adaptiveLookback_raw * 0.8
health_stat_valid = adaptiveLookback >= stat_required * 0.9

//========================
// Adaptive Threshold Selection (è‡ªé€‚åº”é˜ˆå€¼é€‰æ‹©)
//========================

// åŒé‡æ£€æµ‹ç³»ç»Ÿï¼ˆå¿«é€Ÿè§¦å‘ + æ…¢é€Ÿç¡®è®¤ï¼‰
vol_fast_period = int(rsiLen * 1.5)  // å¿«é€Ÿæ£€æµ‹ï¼šçº¦ 21 æ ¹ K çº¿ï¼ˆå¦‚æœ RSI=14ï¼‰
vol_fast = ta.stdev(spyRSI, vol_fast_period)

vol_slow_period = int(rsiLen * 3)    // æ…¢é€Ÿç¡®è®¤ï¼šçº¦ 42 æ ¹ K çº¿
vol_slow = ta.stdev(spyRSI, vol_slow_period)

// è‡ªåŠ¨æ¨¡å¼é€»è¾‘ï¼šå¿«é€Ÿæ£€æµ‹ OR æ…¢é€Ÿç¡®è®¤
useAdaptive = thresholdMode == "Auto" ? 
              (vol_fast > rsiVolThreshold or vol_slow > rsiVolThreshold * 1.2) : 
              thresholdMode == "Adaptive"

// Dynamic Cooldown Calculation (åŠ¨æ€å†·å´è®¡ç®—)
// åœ¨æ³¢åŠ¨ç‡è®¡ç®—ååº”ç”¨åŠ¨æ€å†·å´
cooldownBars = useDynamicCooldown ? f_dynamicCooldown(cooldownBarsBase, vol_fast, rsiVolThreshold) : cooldownBarsBase
divCooldownDynamic = useDynamicCooldown ? f_dynamicCooldown(divCooldownBars, vol_fast, rsiVolThreshold) : divCooldownBars

[spyAdaptOS1, spyAdaptOS2, spyAdaptOB1, spyAdaptOB2] = f_adaptiveThresholds(spyRSI, adaptiveLookback)
[qqqAdaptOS1, qqqAdaptOS2, qqqAdaptOB1, qqqAdaptOB2] = f_adaptiveThresholds(qqqRSI, adaptiveLookback)
[iwmAdaptOS1, iwmAdaptOS2, iwmAdaptOB1, iwmAdaptOB2] = f_adaptiveThresholds(iwmRSI, adaptiveLookback)

spyOS1 = useAdaptive ? spyAdaptOS1 : fixedRsiOversold1
spyOS2 = useAdaptive ? spyAdaptOS2 : fixedRsiOversold2
spyOB1 = useAdaptive ? spyAdaptOB1 : fixedRsiOverbought1
spyOB2 = useAdaptive ? spyAdaptOB2 : fixedRsiOverbought2

qqqOS1 = useAdaptive ? qqqAdaptOS1 : fixedRsiOversold1
qqqOS2 = useAdaptive ? qqqAdaptOS2 : fixedRsiOversold2
qqqOB1 = useAdaptive ? qqqAdaptOB1 : fixedRsiOverbought1
qqqOB2 = useAdaptive ? qqqAdaptOB2 : fixedRsiOverbought2

iwmOS1 = useAdaptive ? iwmAdaptOS1 : fixedRsiOversold1
iwmOS2 = useAdaptive ? iwmAdaptOS2 : fixedRsiOversold2
iwmOB1 = useAdaptive ? iwmAdaptOB1 : fixedRsiOverbought1
iwmOB2 = useAdaptive ? iwmAdaptOB2 : fixedRsiOverbought2

// å¥åº·åº¦ï¼šåˆ†å¸ƒå®½åº¦æ£€æŸ¥ï¼ˆå¤§ç›˜æŒ‡æ•°ä¼˜åŒ–ï¼šâ‰¥12ï¼‰
health_distribution_spread = (spyOB1 - spyOS1) >= 12
health_ok = health_sample_coverage and health_stat_valid and health_distribution_spread

//========================
// Calculate Scores per Market
//========================
[spyScoreRaw, spyRsiS, spyFiS, spyTwS, spyVolS, spyAddS] = f_totalScore(spyRSI, s5tw, s5fi, uvol, dvol, addValue, intradayMode, spyOS1, spyOS2, spyOB1, spyOB2)
[qqqScoreRaw, qqqRsiS, qqqFiS, qqqTwS, qqqVolS, qqqAddS] = f_totalScore(qqqRSI, nctw, ncfi, uvolq, dvolq, addValue, intradayMode, qqqOS1, qqqOS2, qqqOB1, qqqOB2)
[iwmScoreRaw, iwmRsiS, iwmFiS, iwmTwS, iwmVolS, iwmAddS] = f_totalScore(iwmRSI, r2tw, r2fi, uvol, dvol, addValue, intradayMode, iwmOS1, iwmOS2, iwmOB1, iwmOB2)

//========================
// v7.0: Apply Drawdown Bonus (å›æ’¤åŠ åˆ†)
//========================
spyHigh252 = ta.highest(spyC, 252)
qqqHigh252 = ta.highest(qqqC, 252)
iwmHigh252 = ta.highest(iwmC, 252)

[spyDrawdownBonus, spyDrawdown] = f_drawdownBonus(spyC, spyHigh252)
[qqqDrawdownBonus, qqqDrawdown] = f_drawdownBonus(qqqC, qqqHigh252)
[iwmDrawdownBonus, iwmDrawdown] = f_drawdownBonus(iwmC, iwmHigh252)

// åº”ç”¨å›æ’¤åŠ åˆ† (ä»…é™ä¹°å…¥æ–¹å‘)
spyScore = useDrawdownBonus ? spyScoreRaw + spyDrawdownBonus : spyScoreRaw
qqqScore = useDrawdownBonus ? qqqScoreRaw + qqqDrawdownBonus : qqqScoreRaw
iwmScore = useDrawdownBonus ? iwmScoreRaw + iwmDrawdownBonus : iwmScoreRaw

//========================
// v7.0: Signal Quality Assessment (ä¿¡å·è´¨é‡è¯„ä¼°)
//========================
[spyBuyQuality, spySellQuality, spyPosFactor, spyNegFactor] = f_signalQuality(spyRsiS, spyFiS, spyTwS, spyVolS, spyAddS, intradayMode)
[qqqBuyQuality, qqqSellQuality, qqqPosFactor, qqqNegFactor] = f_signalQuality(qqqRsiS, qqqFiS, qqqTwS, qqqVolS, qqqAddS, intradayMode)
[iwmBuyQuality, iwmSellQuality, iwmPosFactor, iwmNegFactor] = f_signalQuality(iwmRsiS, iwmFiS, iwmTwS, iwmVolS, iwmAddS, intradayMode)

// ä¿¡å·è´¨é‡è¿‡æ»¤: ä»…A/Bçº§ä¿¡å·é€šè¿‡
spyBuyQualityOK = not useSignalQuality or spyBuyQuality != "C"
qqqBuyQualityOK = not useSignalQuality or qqqBuyQuality != "C"
iwmBuyQualityOK = not useSignalQuality or iwmBuyQuality != "C"
spySellQualityOK = not useSignalQuality or spySellQuality != "C"
qqqSellQualityOK = not useSignalQuality or qqqSellQuality != "C"
iwmSellQualityOK = not useSignalQuality or iwmSellQuality != "C"

//========================
// Divergence Calculation
//========================
// åŠ¨æ€èƒŒç¦»å›æº¯æœŸï¼ˆå…³è” RSI é•¿åº¦ï¼‰
div_lookback = int(rsiLen * 4)  // å¦‚æœ RSI=14ï¼Œåˆ™ 56 æ ¹ K çº¿

[spyDivStrength, spyPriceZ, spyRsiZ] = f_divergence(spyC, spyRSI, div_lookback)
[qqqDivStrength, qqqPriceZ, qqqRsiZ] = f_divergence(qqqC, qqqRSI, div_lookback)
[iwmDivStrength, iwmPriceZ, iwmRsiZ] = f_divergence(iwmC, iwmRSI, div_lookback)

// åŸå§‹èƒŒç¦»æ£€æµ‹ï¼ˆåœ¨ OS2/OB2 åŒºåŸŸè§¦å‘ï¼Œå¹³è¡¡è´¨é‡ä¸çµæ•åº¦ï¼‰
spyBullishDivRaw = useDivergence and spyDivStrength < -divZScoreThreshold and spyRSI < spyOS2
spyBearishDivRaw = useDivergence and spyDivStrength > divZScoreThreshold and spyRSI > spyOB2
qqqBullishDivRaw = useDivergence and qqqDivStrength < -divZScoreThreshold and qqqRSI < qqqOS2
qqqBearishDivRaw = useDivergence and qqqDivStrength > divZScoreThreshold and qqqRSI > qqqOB2
iwmBullishDivRaw = useDivergence and iwmDivStrength < -divZScoreThreshold and iwmRSI < iwmOS2
iwmBearishDivRaw = useDivergence and iwmDivStrength > divZScoreThreshold and iwmRSI > iwmOB2

// å†·å´æœŸçŠ¶æ€è¿½è¸ª
var int spyLastBullDiv = na
var int spyLastBearDiv = na
var int qqqLastBullDiv = na
var int qqqLastBearDiv = na
var int iwmLastBullDiv = na
var int iwmLastBearDiv = na

// åº”ç”¨å†·å´æœŸè¿‡æ»¤
spyBullishDiv = f_applyCooldown(spyBullishDivRaw, divCooldownDynamic, spyLastBullDiv)
spyBearishDiv = f_applyCooldown(spyBearishDivRaw, divCooldownDynamic, spyLastBearDiv)
qqqBullishDiv = f_applyCooldown(qqqBullishDivRaw, divCooldownDynamic, qqqLastBullDiv)
qqqBearishDiv = f_applyCooldown(qqqBearishDivRaw, divCooldownDynamic, qqqLastBearDiv)
iwmBullishDiv = f_applyCooldown(iwmBullishDivRaw, divCooldownDynamic, iwmLastBullDiv)
iwmBearishDiv = f_applyCooldown(iwmBearishDivRaw, divCooldownDynamic, iwmLastBearDiv)

// æ›´æ–°å†·å´æœŸçŠ¶æ€
if spyBullishDiv
    spyLastBullDiv := bar_index
if spyBearishDiv
    spyLastBearDiv := bar_index
if qqqBullishDiv
    qqqLastBullDiv := bar_index
if qqqBearishDiv
    qqqLastBearDiv := bar_index
if iwmBullishDiv
    iwmLastBullDiv := bar_index
if iwmBearishDiv
    iwmLastBearDiv := bar_index

//========================
// Trend MA & Signals (using modular function)
//========================
spyTrendMA = ta.sma(spyC, trendMALen)
qqqTrendMA = ta.sma(qqqC, trendMALen)
iwmTrendMA = ta.sma(iwmC, trendMALen)

spyUptrend = spyC > spyTrendMA
qqqUptrend = qqqC > qqqTrendMA
iwmUptrend = iwmC > iwmTrendMA

// åŸå§‹ä¿¡å·ç”Ÿæˆ
[spyStrongBotRaw, spyBotOnly, spyTopOnly, spyStrongTopRaw, spyElevatedRaw, spyBotRawBase, spyTopRawBase] = f_generateSignals(spyScore, spyUptrend, adjBotThreshold, adjStrongBotThreshold, adjTopThreshold, adjStrongTopThreshold)
[qqqStrongBotRaw, qqqBotOnly, qqqTopOnly, qqqStrongTopRaw, qqqElevatedRaw, qqqBotRawBase, qqqTopRawBase] = f_generateSignals(qqqScore, qqqUptrend, adjBotThreshold, adjStrongBotThreshold, adjTopThreshold, adjStrongTopThreshold)
[iwmStrongBotRaw, iwmBotOnly, iwmTopOnly, iwmStrongTopRaw, iwmElevatedRaw, iwmBotRawBase, iwmTopRawBase] = f_generateSignals(iwmScore, iwmUptrend, adjBotThreshold, adjStrongBotThreshold, adjTopThreshold, adjStrongTopThreshold)

// v7.0: åº”ç”¨èƒŒç¦»åŠ©æ¨ (è¾¹ç¼˜ä¿¡å·å¯è¢«èƒŒç¦»è§¦å‘)
spyBotAssisted = f_divergenceAssisted(spyScore, adjBotThreshold, spyBullishDivRaw, useDivergenceAssist)
qqqBotAssisted = f_divergenceAssisted(qqqScore, adjBotThreshold, qqqBullishDivRaw, useDivergenceAssist)
iwmBotAssisted = f_divergenceAssisted(iwmScore, adjBotThreshold, iwmBullishDivRaw, useDivergenceAssist)

// v7.0: åº”ç”¨ä¿¡å·è´¨é‡è¿‡æ»¤ (ç¡®ä¿ä¿¡å·äº’æ–¥)
spyStrongBot = spyStrongBotRaw and spyBuyQualityOK
spyBot = (spyBotOnly or (spyBotAssisted and not spyBotOnly)) and spyBuyQualityOK and not spyStrongBot
spyTop = spyTopOnly and spySellQualityOK
spyStrongTop = spyStrongTopRaw and spySellQualityOK
spyElevated = spyElevatedRaw
spyBotRaw = (spyStrongBot or spyBot)
spyTopRaw = (spyStrongTop or spyTop)

qqqStrongBot = qqqStrongBotRaw and qqqBuyQualityOK
qqqBot = (qqqBotOnly or (qqqBotAssisted and not qqqBotOnly)) and qqqBuyQualityOK and not qqqStrongBot
qqqTop = qqqTopOnly and qqqSellQualityOK
qqqStrongTop = qqqStrongTopRaw and qqqSellQualityOK
qqqElevated = qqqElevatedRaw
qqqBotRaw = (qqqStrongBot or qqqBot)
qqqTopRaw = (qqqStrongTop or qqqTop)

iwmStrongBot = iwmStrongBotRaw and iwmBuyQualityOK
iwmBot = (iwmBotOnly or (iwmBotAssisted and not iwmBotOnly)) and iwmBuyQualityOK and not iwmStrongBot
iwmTop = iwmTopOnly and iwmSellQualityOK
iwmStrongTop = iwmStrongTopRaw and iwmSellQualityOK
iwmElevated = iwmElevatedRaw
iwmBotRaw = (iwmStrongBot or iwmBot)
iwmTopRaw = (iwmStrongTop or iwmTop)

//========================
// Cooldown state
//========================
var int spyLastBot = na
var int spyLastTop = na
var int qqqLastBot = na
var int qqqLastTop = na
var int iwmLastBot = na
var int iwmLastTop = na

spyBotTrig = f_applyCooldown(spyBotRaw, cooldownBars, spyLastBot)
spyTopTrig = f_applyCooldown(spyTopRaw, cooldownBars, spyLastTop)
qqqBotTrig = f_applyCooldown(qqqBotRaw, cooldownBars, qqqLastBot)
qqqTopTrig = f_applyCooldown(qqqTopRaw, cooldownBars, qqqLastTop)
iwmBotTrig = f_applyCooldown(iwmBotRaw, cooldownBars, iwmLastBot)
iwmTopTrig = f_applyCooldown(iwmTopRaw, cooldownBars, iwmLastTop)

if spyBotTrig
    spyLastBot := bar_index
if spyTopTrig
    spyLastTop := bar_index
if qqqBotTrig
    qqqLastBot := bar_index
if qqqTopTrig
    qqqLastTop := bar_index
if iwmBotTrig
    iwmLastBot := bar_index
if iwmTopTrig
    iwmLastTop := bar_index

//========================
// Aggregate resonance
//========================
spyBotRecent = f_recent(spyBotTrig, confirmBars)
qqqBotRecent = f_recent(qqqBotTrig, confirmBars)
iwmBotRecent = f_recent(iwmBotTrig, confirmBars)

spyTopRecent = f_recent(spyTopTrig, confirmBars)
qqqTopRecent = f_recent(qqqTopTrig, confirmBars)
iwmTopRecent = f_recent(iwmTopTrig, confirmBars)

agreeBot = (spyBotRecent ? 1 : 0) + (qqqBotRecent ? 1 : 0) + (iwmBotRecent ? 1 : 0)
agreeTop = (spyTopRecent ? 1 : 0) + (qqqTopRecent ? 1 : 0) + (iwmTopRecent ? 1 : 0)

aggBottom = agreeBot >= minAgree
aggTop    = agreeTop >= minAgree

aggBottomEdge = aggBottom and not aggBottom[1]
aggTopEdge    = aggTop and not aggTop[1]

//========================
// v7.0: Tiered Resonance System (åˆ†çº§å…±æŒ¯)
//========================
[botResonanceStrength, botResonanceBonus, botSyncResonance, botSyncCount, botWindowCount] = f_resonanceStrength(spyBotTrig, qqqBotTrig, iwmBotTrig, spyBotRecent, qqqBotRecent, iwmBotRecent)
[topResonanceStrength, topResonanceBonus, topSyncResonance, topSyncCount, topWindowCount] = f_resonanceStrength(spyTopTrig, qqqTopTrig, iwmTopTrig, spyTopRecent, qqqTopRecent, iwmTopRecent)

//========================
// Plot selection
//========================
tickerName = str.upper(syminfo.ticker)
isSpy = str.contains(tickerName, "SPY") or str.contains(tickerName, "SPX") or tickerName == "ES" or tickerName == "MES" or str.contains(tickerName, "ES1!")
isQqq = str.contains(tickerName, "QQQ") or str.contains(tickerName, "NDX") or tickerName == "NQ" or tickerName == "MNQ" or str.contains(tickerName, "NQ1!")
isIwm = str.contains(tickerName, "IWM") or str.contains(tickerName, "RUT") or str.contains(tickerName, "RTY") or tickerName == "M2K"

modePlot = plotMode == "AUTO" ? (isSpy ? "SPY" : isQqq ? "QQQ" : isIwm ? "IWM" : "AGG(å…±æŒ¯)") : plotMode
showSpy = modePlot == "SPY"
showQqq = modePlot == "QQQ"
showIwm = modePlot == "IWM"
showAgg = modePlot == "AGG(å…±æŒ¯)"

// v7.0: Add resonance bonus to display score
displayResonanceBonus = showAgg ? botResonanceBonus : 0.0
displayScoreBase = showSpy ? spyScore : showQqq ? qqqScore : showIwm ? iwmScore : (spyScore + qqqScore + iwmScore) / 3
displayScore = displayScoreBase + displayResonanceBonus
displayRsiS = showSpy ? spyRsiS : showQqq ? qqqRsiS : showIwm ? iwmRsiS : (spyRsiS + qqqRsiS + iwmRsiS) / 3
displayFiS = showSpy ? spyFiS : showQqq ? qqqFiS : showIwm ? iwmFiS : (spyFiS + qqqFiS + iwmFiS) / 3
displayTwS = showSpy ? spyTwS : showQqq ? qqqTwS : showIwm ? iwmTwS : (spyTwS + qqqTwS + iwmTwS) / 3
displayVolS = showSpy ? spyVolS : showQqq ? qqqVolS : showIwm ? iwmVolS : (spyVolS + qqqVolS + iwmVolS) / 3
displayAddS = showSpy ? spyAddS : showQqq ? qqqAddS : showIwm ? iwmAddS : (spyAddS + qqqAddS + iwmAddS) / 3

displayBullishDiv = showSpy ? spyBullishDiv : showQqq ? qqqBullishDiv : showIwm ? iwmBullishDiv : (spyBullishDiv or qqqBullishDiv or iwmBullishDiv)
displayBearishDiv = showSpy ? spyBearishDiv : showQqq ? qqqBearishDiv : showIwm ? iwmBearishDiv : (spyBearishDiv or qqqBearishDiv or iwmBearishDiv)

// v7.0: Display signal quality and drawdown
displayBuyQuality = showSpy ? spyBuyQuality : showQqq ? qqqBuyQuality : showIwm ? iwmBuyQuality : (spyPosFactor >= qqqPosFactor and spyPosFactor >= iwmPosFactor ? spyBuyQuality : qqqPosFactor >= iwmPosFactor ? qqqBuyQuality : iwmBuyQuality)
displayDrawdown = showSpy ? spyDrawdown : showQqq ? qqqDrawdown : showIwm ? iwmDrawdown : (spyDrawdown + qqqDrawdown + iwmDrawdown) / 3
displayDrawdownBonus = showSpy ? spyDrawdownBonus : showQqq ? qqqDrawdownBonus : showIwm ? iwmDrawdownBonus : (spyDrawdownBonus + qqqDrawdownBonus + iwmDrawdownBonus) / 3
displayPosFactor = showSpy ? spyPosFactor : showQqq ? qqqPosFactor : showIwm ? iwmPosFactor : int((spyPosFactor + qqqPosFactor + iwmPosFactor) / 3)

//========================
// Signal Zone State (v7.0: ä¿¡å·åŒºé—´çŠ¶æ€è·Ÿè¸ª)
//========================
// ä¿¡å·è§¦å‘æ¡ä»¶ (ä½¿ç”¨å½“å‰æ˜¾ç¤ºæ¨¡å¼çš„ä¿¡å·)
displayBotTrig = showSpy ? spyBotTrig : showQqq ? qqqBotTrig : showIwm ? iwmBotTrig : aggBottomEdge
displayTopTrig = showSpy ? spyTopTrig : showQqq ? qqqTopTrig : showIwm ? iwmTopTrig : aggTopEdge
displayBotSignal = showSpy ? (spyStrongBot or spyBot) : showQqq ? (qqqStrongBot or qqqBot) : showIwm ? (iwmStrongBot or iwmBot) : aggBottom
displayTopSignal = showSpy ? (spyStrongTop or spyTop) : showQqq ? (qqqStrongTop or qqqTop) : showIwm ? (iwmStrongTop or iwmTop) : aggTop

// HOLD åŒºé—´: è¯„åˆ†åœ¨ä¹°å…¥å’Œå–å‡ºé˜ˆå€¼ä¹‹é—´
isHoldZone = displayScore < adjBotThreshold and displayScore > adjTopThreshold

// ä½¿ç”¨ var è·Ÿè¸ªå½“å‰åŒºé—´çŠ¶æ€ (0=æ— , 1=ä¹°å…¥åŒºé—´, -1=å–å‡ºåŒºé—´)
var int signalZoneState = 0

// çŠ¶æ€è½¬æ¢é€»è¾‘
if displayBotTrig and displayBotSignal
    signalZoneState := 1  // è¿›å…¥ä¹°å…¥åŒºé—´
else if displayTopTrig and displayTopSignal
    signalZoneState := -1  // è¿›å…¥å–å‡ºåŒºé—´
else if isHoldZone
    signalZoneState := 0  // å›åˆ° HOLDï¼Œç»“æŸåŒºé—´

// èƒŒæ™¯é¢œè‰²
buyZoneColor = color.new(color.lime, 90)  // ç»¿è‰²åŠé€æ˜
sellZoneColor = color.new(color.red, 90)  // çº¢è‰²åŠé€æ˜

// ç»˜åˆ¶èƒŒæ™¯
bgcolor(showSignalZone and signalZoneState == 1 ? buyZoneColor : na, title="Buy Zone Background")
bgcolor(showSignalZone and signalZoneState == -1 ? sellZoneColor : na, title="Sell Zone Background")

//========================
// Plot shapes
//========================
// SPY
plotshape(showSpy and spyBotTrig and spyStrongBot, title="SPY Panic Low", style=shape.labelup, location=location.belowbar, color=color.new(color.lime, 0), textcolor=color.black, size=size.normal, text="ğŸš€")
plotshape(showSpy and spyBotTrig and spyBot, title="SPY Buy Zone", style=shape.triangleup, location=location.belowbar, color=color.new(color.lime, 0), size=size.small, text="ğŸ“ˆ")
plotshape(showSpy and spyTopTrig and spyStrongTop, title="SPY Reduce", style=shape.labeldown, location=location.abovebar, color=color.new(color.red, 0), textcolor=color.white, size=size.normal, text="âš ï¸")
plotshape(showSpy and spyTopTrig and spyTop, title="SPY Caution", style=shape.triangledown, location=location.abovebar, color=color.new(color.orange, 0), size=size.small, text="âš¡")
plotshape(showSpy and spyElevated and not spyElevated[1], title="SPY Elevated", style=shape.diamond, location=location.abovebar, color=color.new(color.yellow, 0), size=size.tiny, text="â­")
plotshape(showSpy and spyBullishDiv and not spyBullishDiv[1], title="SPY Bullish Div", style=shape.labelup, location=location.belowbar, color=color.new(color.aqua, 0), textcolor=color.black, size=size.small, text="ğŸ’")
plotshape(showSpy and spyBearishDiv and not spyBearishDiv[1], title="SPY Bearish Div", style=shape.labeldown, location=location.abovebar, color=color.new(color.fuchsia, 0), textcolor=color.white, size=size.small, text="ğŸ’")

// QQQ
plotshape(showQqq and qqqBotTrig and qqqStrongBot, title="QQQ Panic Low", style=shape.labelup, location=location.belowbar, color=color.new(color.lime, 0), textcolor=color.black, size=size.normal, text="ğŸš€")
plotshape(showQqq and qqqBotTrig and qqqBot, title="QQQ Buy Zone", style=shape.triangleup, location=location.belowbar, color=color.new(color.lime, 0), size=size.small, text="ğŸ“ˆ")
plotshape(showQqq and qqqTopTrig and qqqStrongTop, title="QQQ Reduce", style=shape.labeldown, location=location.abovebar, color=color.new(color.red, 0), textcolor=color.white, size=size.normal, text="âš ï¸")
plotshape(showQqq and qqqTopTrig and qqqTop, title="QQQ Caution", style=shape.triangledown, location=location.abovebar, color=color.new(color.orange, 0), size=size.small, text="âš¡")
plotshape(showQqq and qqqElevated and not qqqElevated[1], title="QQQ Elevated", style=shape.diamond, location=location.abovebar, color=color.new(color.yellow, 0), size=size.tiny, text="â­")
plotshape(showQqq and qqqBullishDiv and not qqqBullishDiv[1], title="QQQ Bullish Div", style=shape.labelup, location=location.belowbar, color=color.new(color.aqua, 0), textcolor=color.black, size=size.small, text="ğŸ’")
plotshape(showQqq and qqqBearishDiv and not qqqBearishDiv[1], title="QQQ Bearish Div", style=shape.labeldown, location=location.abovebar, color=color.new(color.fuchsia, 0), textcolor=color.white, size=size.small, text="ğŸ’")

// IWM
plotshape(showIwm and iwmBotTrig and iwmStrongBot, title="IWM Panic Low", style=shape.labelup, location=location.belowbar, color=color.new(color.lime, 0), textcolor=color.black, size=size.normal, text="ğŸš€")
plotshape(showIwm and iwmBotTrig and iwmBot, title="IWM Buy Zone", style=shape.triangleup, location=location.belowbar, color=color.new(color.lime, 0), size=size.small, text="ğŸ“ˆ")
plotshape(showIwm and iwmTopTrig and iwmStrongTop, title="IWM Reduce", style=shape.labeldown, location=location.abovebar, color=color.new(color.red, 0), textcolor=color.white, size=size.normal, text="âš ï¸")
plotshape(showIwm and iwmTopTrig and iwmTop, title="IWM Caution", style=shape.triangledown, location=location.abovebar, color=color.new(color.orange, 0), size=size.small, text="âš¡")
plotshape(showIwm and iwmElevated and not iwmElevated[1], title="IWM Elevated", style=shape.diamond, location=location.abovebar, color=color.new(color.yellow, 0), size=size.tiny, text="â­")
plotshape(showIwm and iwmBullishDiv and not iwmBullishDiv[1], title="IWM Bullish Div", style=shape.labelup, location=location.belowbar, color=color.new(color.aqua, 0), textcolor=color.black, size=size.small, text="ğŸ’")
plotshape(showIwm and iwmBearishDiv and not iwmBearishDiv[1], title="IWM Bearish Div", style=shape.labeldown, location=location.abovebar, color=color.new(color.fuchsia, 0), textcolor=color.white, size=size.small, text="ğŸ’")

// AGG å…±æŒ¯
plotshape(showAgg and aggBottomEdge, title="Resonance Buy", style=shape.labelup, location=location.belowbar, color=color.new(color.lime, 0), textcolor=color.black, text="ğŸ”¥")
plotshape(showAgg and aggTopEdge, title="Resonance Risk", style=shape.labeldown, location=location.abovebar, color=color.new(color.red, 0), textcolor=color.white, text="â„ï¸")

//========================
// Dashboard
//========================
displayUptrend = showSpy ? spyUptrend : showQqq ? qqqUptrend : showIwm ? iwmUptrend : (spyUptrend and qqqUptrend) or (spyUptrend and iwmUptrend) or (qqqUptrend and iwmUptrend)
displayElevated = showSpy ? spyElevated : showQqq ? qqqElevated : showIwm ? iwmElevated : (spyElevated or qqqElevated or iwmElevated)

thresholdModeText = useAdaptive ? "Adaptive" : "Fixed"

// Position mapping ä½ç½®æ˜ å°„
f_getPosition(_pos) =>
    switch _pos
        "Top Left"     => position.top_left
        "Top Right"    => position.top_right
        "Bottom Left"  => position.bottom_left
        "Bottom Right" => position.bottom_right
        "Middle Left"  => position.middle_left
        "Middle Right" => position.middle_right
        => position.top_right

// Font size mapping å­—ä½“æ˜ å°„
f_getFontSize(_size) =>
    switch _size
        "Tiny"   => size.tiny
        "Small"  => size.small
        "Normal" => size.normal
        "Large"  => size.large
        => size.small

// Dashboard display variables
useMobileMode = dashboardMode == "Mobile"
dashboardPos = f_getPosition(dashboardPosition)
fontSize = f_getFontSize(dashboardFontSize)
fontSizeHeader = dashboardFontSize == "Large" ? size.large : dashboardFontSize == "Normal" ? size.normal : size.normal

// Prepare signal text (used in both modes)
totalColor = displayScore >= adjBotThreshold ? color.lime : displayScore <= adjTopThreshold ? (displayUptrend ? color.yellow : color.red) : color.gray
signalText = displayScore >= adjStrongBotThreshold ? "PANIC LOW" :
             displayScore >= adjBotThreshold ? "BUY ZONE" :
             displayElevated ? "ELEVATED" :
             displayScore <= adjStrongTopThreshold ? "REDUCE" :
             displayScore <= adjTopThreshold ? "CAUTION" :
             "HOLD"
signalEmoji = displayScore >= adjStrongBotThreshold ? "ğŸš€" : 
              displayScore >= adjBotThreshold ? "ğŸ“ˆ" : 
              displayElevated ? "â­" :
              displayScore <= adjStrongTopThreshold ? "âš ï¸" : 
              displayScore <= adjTopThreshold ? "âš¡" : "âšª"

// Divergence display
divColor = displayBullishDiv ? color.aqua : displayBearishDiv ? color.fuchsia : color.gray
thresholdColor = useAdaptive ? color.aqua : color.yellow

if showDashboard and barstate.islast
    if useMobileMode
        // Mobile Mode: Compact 4-row Ã— 2-col display (v7.0 adds Quality row)
        var table dashboardMobile = table.new(dashboardPos, 2, 4, bgcolor=color.new(color.black, 80), frame_color=color.gray, frame_width=1, border_color=color.gray, border_width=1)

        // Row 0: Signal Emoji + Signal Text
        table.cell(dashboardMobile, 0, 0, signalEmoji, text_color=totalColor, text_size=fontSizeHeader)
        table.cell(dashboardMobile, 1, 0, signalText, text_color=totalColor, text_size=fontSize)

        // Row 1: Score + Trend
        scoreStr = str.tostring(displayScore, "#.#") + " " + (displayUptrend ? "â†‘" : "â†“")
        table.cell(dashboardMobile, 0, 1, "Score", text_color=color.white, text_size=fontSize)
        table.cell(dashboardMobile, 1, 1, scoreStr, text_color=totalColor, text_size=fontSize)

        // Row 2: Quality + Drawdown (v7.0)
        qualityColor = displayBuyQuality == "A" ? color.lime : displayBuyQuality == "B" ? color.yellow : color.gray
        qualityStr = displayBuyQuality + " (" + str.tostring(displayPosFactor) + "F)"
        ddStr = displayDrawdown >= 5 ? str.tostring(displayDrawdown, "#.#") + "%" : "-"
        ddColor = displayDrawdown >= 10 ? color.lime : displayDrawdown >= 5 ? color.yellow : color.gray
        table.cell(dashboardMobile, 0, 2, qualityStr, text_color=qualityColor, text_size=fontSize)
        table.cell(dashboardMobile, 1, 2, "DD:" + ddStr, text_color=ddColor, text_size=fontSize)

        // Row 3: Mode + Divergence
        divStatus = displayBullishDiv ? "ğŸ’â†‘" : displayBearishDiv ? "ğŸ’â†“" : "-"
        table.cell(dashboardMobile, 0, 3, thresholdModeText, text_color=thresholdColor, text_size=fontSize)
        table.cell(dashboardMobile, 1, 3, divStatus, text_color=divColor, text_size=fontSize)
    else
        // Full Mode: 13-row Ã— 3-col display (v7.0 adds Quality + Drawdown rows)
        var table dashboard = table.new(dashboardPos, 3, 13, bgcolor=color.new(color.black, 80), frame_color=color.gray, frame_width=1, border_color=color.gray, border_width=1)
        
        // Header
        table.cell(dashboard, 0, 0, "Factor", text_color=color.white, text_size=fontSize)
        table.cell(dashboard, 1, 0, "Score", text_color=color.white, text_size=fontSize)
        table.cell(dashboard, 2, 0, "Weight", text_color=color.white, text_size=fontSize)
        
        // RSI
        rsiColor = displayRsiS > 0 ? color.lime : displayRsiS < 0 ? color.red : color.gray
        table.cell(dashboard, 0, 1, "RSI", text_color=color.white, text_size=fontSize)
        table.cell(dashboard, 1, 1, str.tostring(displayRsiS, "#.#"), text_color=rsiColor, text_size=fontSize)
        table.cell(dashboard, 2, 1, "1x", text_color=color.gray, text_size=fontSize)
        
        // FI (50D) or ADD (Intraday)
        if intradayMode
            addColor = displayAddS > 0 ? color.lime : displayAddS < 0 ? color.red : color.gray
            table.cell(dashboard, 0, 2, "ADD", text_color=color.white, text_size=fontSize)
            table.cell(dashboard, 1, 2, str.tostring(displayAddS, "#.#"), text_color=addColor, text_size=fontSize)
            table.cell(dashboard, 2, 2, "Intraday", text_color=color.aqua, text_size=fontSize)
        else
            fiColor = displayFiS > 0 ? color.lime : displayFiS < 0 ? color.red : color.gray
            table.cell(dashboard, 0, 2, "FI(50D)", text_color=color.white, text_size=fontSize)
            table.cell(dashboard, 1, 2, str.tostring(displayFiS, "#.#"), text_color=fiColor, text_size=fontSize)
            table.cell(dashboard, 2, 2, "Bottom", text_color=color.lime, text_size=fontSize)
        
        // TW (20D)
        twColor = displayTwS > 0 ? color.lime : displayTwS < 0 ? color.red : color.gray
        table.cell(dashboard, 0, 3, "TW(20D)", text_color=color.white, text_size=fontSize)
        table.cell(dashboard, 1, 3, str.tostring(displayTwS, "#.#"), text_color=twColor, text_size=fontSize)
        table.cell(dashboard, 2, 3, "Top", text_color=color.red, text_size=fontSize)
        
        // Volume
        volColor = displayVolS > 0 ? color.lime : displayVolS < 0 ? color.red : color.gray
        table.cell(dashboard, 0, 4, "Vol", text_color=color.white, text_size=fontSize)
        table.cell(dashboard, 1, 4, str.tostring(displayVolS, "#.#"), text_color=volColor, text_size=fontSize)
        table.cell(dashboard, 2, 4, "1x", text_color=color.gray, text_size=fontSize)
        
        // Trend
        trendText = displayUptrend ? "â†‘ UP" : "â†“ DOWN"
        trendColor = displayUptrend ? color.lime : color.red
        table.cell(dashboard, 0, 5, "Trend", text_color=color.white, text_size=fontSize)
        table.cell(dashboard, 1, 5, trendText, text_color=trendColor, text_size=fontSize)
        table.cell(dashboard, 2, 5, str.tostring(trendMALen) + "MA", text_color=color.gray, text_size=fontSize)
        
        // Threshold Mode
        table.cell(dashboard, 0, 6, "Mode", text_color=color.white, text_size=fontSize)
        table.cell(dashboard, 1, 6, thresholdModeText, text_color=thresholdColor, text_size=fontSize)
        table.cell(dashboard, 2, 6, "Vol=" + str.tostring(vol_fast, "#.#"), text_color=color.gray, text_size=fontSize)
        
        // Divergence
        divText = displayBullishDiv ? "BULL ğŸ’" : displayBearishDiv ? "BEAR ğŸ’" : "-"
        table.cell(dashboard, 0, 7, "Div", text_color=color.white, text_size=fontSize)
        table.cell(dashboard, 1, 7, divText, text_color=divColor, text_size=fontSize)
        table.cell(dashboard, 2, 7, useDivergence ? "ON" : "OFF", text_color=useDivergence ? color.lime : color.gray, text_size=fontSize)

        // Lookback Health
        health_text = health_ok ? "âœ“ OK" : "âš  Check"
        health_color = health_ok ? color.lime : color.orange
        table.cell(dashboard, 0, 8, "Lookback", text_color=color.white, text_size=fontSize)
        table.cell(dashboard, 1, 8, str.tostring(adaptiveLookback), text_color=color.aqua, text_size=fontSize)
        table.cell(dashboard, 2, 8, health_text, text_color=health_color, text_size=fontSize)

        // Cooldown
        cooldown_color = useDynamicCooldown ? color.aqua : color.yellow
        cooldown_text = useDynamicCooldown ? "Dyn" : "Fix"
        table.cell(dashboard, 0, 9, "Cooldown", text_color=color.white, text_size=fontSize)
        table.cell(dashboard, 1, 9, str.tostring(cooldownBars) + "b", text_color=cooldown_color, text_size=fontSize)
        table.cell(dashboard, 2, 9, cooldown_text, text_color=cooldown_color, text_size=fontSize)

        // v7.0: Signal Quality
        qualityColor = displayBuyQuality == "A" ? color.lime : displayBuyQuality == "B" ? color.yellow : color.gray
        qualityText = displayBuyQuality + " Grade"
        factorText = str.tostring(displayPosFactor) + "/4 Factors"
        table.cell(dashboard, 0, 10, "Quality", text_color=color.white, text_size=fontSize)
        table.cell(dashboard, 1, 10, qualityText, text_color=qualityColor, text_size=fontSize)
        table.cell(dashboard, 2, 10, factorText, text_color=qualityColor, text_size=fontSize)

        // v7.0: Drawdown Bonus
        ddColor = displayDrawdown >= 10 ? color.lime : displayDrawdown >= 5 ? color.yellow : color.gray
        ddText = displayDrawdown >= 1 ? str.tostring(displayDrawdown, "#.#") + "%" : "-"
        bonusText = displayDrawdownBonus > 0 ? "+" + str.tostring(displayDrawdownBonus, "#.#") : "-"
        table.cell(dashboard, 0, 11, "Drawdown", text_color=color.white, text_size=fontSize)
        table.cell(dashboard, 1, 11, ddText, text_color=ddColor, text_size=fontSize)
        table.cell(dashboard, 2, 11, bonusText, text_color=ddColor, text_size=fontSize)

        // Total (v7.0: includes drawdown + resonance bonus) - LAST ROW
        resonanceText = displayResonanceBonus > 0 ? "ğŸ”¥+" + str.tostring(displayResonanceBonus, "#.#") : ""
        totalText = str.tostring(displayScore, "#.#") + resonanceText
        table.cell(dashboard, 0, 12, "Total", text_color=color.white, text_size=fontSizeHeader)
        table.cell(dashboard, 1, 12, totalText, text_color=totalColor, text_size=fontSizeHeader)
        table.cell(dashboard, 2, 12, signalText, text_color=totalColor, text_size=fontSize)

//========================
// Smart Alert V2 (Enhanced from Adaptive RSI Pro)
// æ™ºèƒ½è­¦æŠ¥ï¼šä¿¡å·ç­‰çº§ç³»ç»Ÿ + Kçº¿å†…å»é‡ + å‡çº§è§¦å‘ + å¢å¼ºä¸Šä¸‹æ–‡
//========================
grpAlert = "Alerts è­¦æŠ¥"
enable_smart_alert = input.bool(true, "Enable Smart Alert å¯ç”¨æ™ºèƒ½è­¦æŠ¥", group=grpAlert, 
    tooltip="V2æ™ºèƒ½è­¦æŠ¥ï¼šä¿¡å·ç­‰çº§+å‡çº§è§¦å‘+Kçº¿å†…å»é‡\nV2 Smart Alert: signal levels + upgrade trigger + dedup")
min_alert_level_str = input.string("ğŸ”¥ Lv3 Resonance", "Min Alert Level æœ€å°è­¦æŠ¥ç­‰çº§",
    options=["ğŸ“ˆ Lv1 Buy Zone", "ğŸ’ Lv2 Divergence", "ğŸ”¥ Lv3 Resonance", "ğŸš€ Lv4 Panic", "ğŸš€ğŸ”¥ Lv5 Combo"],
    group=grpAlert, tooltip="Only receive alerts >= this level")
min_alert_level = min_alert_level_str == "ğŸ“ˆ Lv1 Buy Zone" ? 1 : min_alert_level_str == "ğŸ’ Lv2 Divergence" ? 2 : min_alert_level_str == "ğŸ”¥ Lv3 Resonance" ? 3 : min_alert_level_str == "ğŸš€ Lv4 Panic" ? 4 : 5

// ä¿¡å·æ¡ä»¶ (è‡ªåŠ¨æ£€æµ‹å›¾è¡¨æ ‡çš„)
autoBotTrig = (isSpy and spyBotTrig) or (isQqq and qqqBotTrig) or (isIwm and iwmBotTrig)
autoStrongBot = (isSpy and spyBotTrig and spyStrongBot) or (isQqq and qqqBotTrig and qqqStrongBot) or (isIwm and iwmBotTrig and iwmStrongBot)
autoTopTrig = (isSpy and spyTopTrig) or (isQqq and qqqTopTrig) or (isIwm and iwmTopTrig)
autoStrongTop = (isSpy and spyTopTrig and spyStrongTop) or (isQqq and qqqTopTrig and qqqStrongTop) or (isIwm and iwmTopTrig and iwmStrongTop)
autoBullishDiv = (isSpy and spyBullishDiv) or (isQqq and qqqBullishDiv) or (isIwm and iwmBullishDiv)
autoBearishDiv = (isSpy and spyBearishDiv) or (isQqq and qqqBearishDiv) or (isIwm and iwmBearishDiv)
autoElevated = (isSpy and spyElevated) or (isQqq and qqqElevated) or (isIwm and iwmElevated)

// ä¿¡å·ç­‰çº§å‡½æ•° (ä¼˜å…ˆçº§è¶Šé«˜å€¼è¶Šå¤§)
// 5=ææ…Œ+å…±æŒ¯ | 4=ææ…Œä½ç‚¹ | 3=å…±æŒ¯ | 2=èƒŒç¦» | 1=ä½å¸/è§‚æœ›
f_buy_level(_strongBot, _bot, _resonance, _div) =>
    _strongBot and _resonance ? 5 : _strongBot ? 4 : _resonance ? 3 : _div ? 2 : _bot ? 1 : 0

f_sell_level(_strongTop, _top, _resonance, _div, _elevated) =>
    _strongTop and _resonance ? 5 : _strongTop ? 4 : _resonance ? 3 : _div ? 2 : (_top or _elevated) ? 1 : 0

// varip: è¿½è¸ªå½“å‰Kçº¿å†…å·²å‘é€çš„æœ€é«˜ä¿¡å·ç­‰çº§ (Kçº¿æ”¶ç›˜æ—¶è‡ªåŠ¨é‡ç½®)
varip int buy_alert_level_sent = 0
varip int sell_alert_level_sent = 0

// æ–°Kçº¿å¼€å§‹æ—¶é‡ç½®
if barstate.isnew
    buy_alert_level_sent := 0
    sell_alert_level_sent := 0

if enable_smart_alert
    // === ä¹°å…¥ä¿¡å· ===
    has_buy_signal = autoBotTrig or aggBottomEdge or autoBullishDiv
    has_buy_signal_prev = autoBotTrig[1] or aggBottomEdge[1] or autoBullishDiv[1]
    current_buy_level = f_buy_level(autoStrongBot, autoBotTrig, aggBottomEdge, autoBullishDiv)

    // è§¦å‘æ¡ä»¶ï¼šæ–°ä¿¡å·(ä¸Šå‡æ²¿) ä¸” (æœªå‘é€è¿‡ æˆ– å½“å‰ç­‰çº§æ›´é«˜) ä¸” è¾¾åˆ°æœ€å°ç­‰çº§
    should_alert_buy = has_buy_signal and not has_buy_signal_prev and current_buy_level > buy_alert_level_sent and current_buy_level >= min_alert_level

    if should_alert_buy
        msg = str.format("{0}: ğŸŸ¢ BUY Lv{1} â†’ ", syminfo.ticker, current_buy_level)

        // Signal labels (combo priority)
        if autoStrongBot and aggBottomEdge
            msg := msg + "ğŸš€Panic+ğŸ”¥Resonance "
        else if autoStrongBot
            msg := msg + "ğŸš€Panic Low "
        else if aggBottomEdge
            msg := msg + "ğŸ”¥Resonance "
        else if autoBotTrig
            msg := msg + "ğŸ“ˆBuy Zone "
        if autoBullishDiv
            msg := msg + "ğŸ’Divergence "

        // v7.0 Context info (quality + drawdown + score)
        trend_ctx = displayUptrend ? "â†‘UP" : "â†“DOWN"
        dd_ctx = displayDrawdown >= 5 ? str.format(" DD:{0,number,#}%", displayDrawdown) : ""
        msg := msg + str.format("| Score:{0,number,#.1} ({1}){2} {3}",
            displayScore, displayBuyQuality, dd_ctx, trend_ctx)

        alert(msg, alert.freq_once_per_bar)
        buy_alert_level_sent := current_buy_level

    // === å–å‡º/é£é™©ä¿¡å· ===
    has_sell_signal = autoTopTrig or aggTopEdge or autoBearishDiv or autoElevated
    has_sell_signal_prev = autoTopTrig[1] or aggTopEdge[1] or autoBearishDiv[1] or autoElevated[1]
    current_sell_level = f_sell_level(autoStrongTop, autoTopTrig, aggTopEdge, autoBearishDiv, autoElevated)

    // è§¦å‘æ¡ä»¶ï¼šæ–°ä¿¡å·(ä¸Šå‡æ²¿) ä¸” (æœªå‘é€è¿‡ æˆ– å½“å‰ç­‰çº§æ›´é«˜) ä¸” è¾¾åˆ°æœ€å°ç­‰çº§
    should_alert_sell = has_sell_signal and not has_sell_signal_prev and current_sell_level > sell_alert_level_sent and current_sell_level >= min_alert_level

    if should_alert_sell
        msg = str.format("{0}: ğŸ”´ RISK Lv{1} â†’ ", syminfo.ticker, current_sell_level)

        // Signal labels (combo priority)
        if autoStrongTop and aggTopEdge
            msg := msg + "âš ï¸Reduce+â„ï¸Resonance "
        else if autoStrongTop
            msg := msg + "âš ï¸Reduce "
        else if aggTopEdge
            msg := msg + "â„ï¸Resonance "
        else if autoTopTrig
            msg := msg + "âš¡Caution "
        else if autoElevated
            msg := msg + "â­Elevated "
        if autoBearishDiv
            msg := msg + "ğŸ’Divergence "

        // v7.0 Context info (score + trend)
        trend_ctx = displayUptrend ? "â†‘Trend" : "â†“DOWN"
        msg := msg + str.format("| Score:{0,number,#.1} {1}", displayScore, trend_ctx)

        alert(msg, alert.freq_once_per_bar)
        sell_alert_level_sent := current_sell_level
