//@version=5
indicator("RSI+Breadth Multi-Factor", overlay=true, max_labels_count=500)

//==============================================================================
// SIGNAL TERMINOLOGY & EMOJI REFERENCE ä¿¡å·æœ¯è¯­ä¸è¡¨æƒ…å‚è€ƒ
//==============================================================================
// Multi-factor scoring: RSI + Market Breadth (TW/FI) + Up/Down Volume
// å¤šå› å­è¯„åˆ†ç³»ç»Ÿï¼šRSI + å¸‚åœºå¹¿åº¦ (TW/FI) + ä¸Šæ¶¨/ä¸‹è·Œæˆäº¤é‡
//
// SIGNAL LEVELS ä¿¡å·çº§åˆ«:
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ Score â”‚ Emoji â”‚ Signal      â”‚ ä¸­æ–‡     â”‚ Action æ“ä½œå»ºè®®                  â”‚
// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
// â”‚ >= 6  â”‚ ğŸš€    â”‚ PANIC LOW   â”‚ ææ…Œä½ç‚¹ â”‚ Strong buy å¼ºçƒˆä¹°å…¥              â”‚
// â”‚ >= 4  â”‚ ğŸ“ˆ    â”‚ BUY ZONE    â”‚ ä½å¸åŒº   â”‚ Accumulate åˆ†æ‰¹å»ºä»“              â”‚
// â”‚ -3~3  â”‚ -     â”‚ HOLD        â”‚ æŒæœ‰     â”‚ Hold position æŒä»“è§‚æœ›           â”‚
// â”‚ <=-4â†‘ â”‚ â­    â”‚ ELEVATED    â”‚ é«˜ä¼°     â”‚ Hold cautious æŒæœ‰ä½†è°¨æ…         â”‚
// â”‚ <=-4â†“ â”‚ âš¡    â”‚ CAUTION     â”‚ è§‚æœ›     â”‚ Take profit æ­¢ç›ˆ                 â”‚
// â”‚ <=-6â†“ â”‚ âš ï¸    â”‚ REDUCE      â”‚ å‡ä»“     â”‚ Reduce position å‡å°‘ä»“ä½         â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
// â†‘ = Uptrend ä¸Šå‡è¶‹åŠ¿ (price > MA)  â†“ = Downtrend ä¸‹é™è¶‹åŠ¿ (price < MA)
//
// RESONANCE å…±æŒ¯ä¿¡å·:
// ğŸ”¥ Resonance Buy  å…±æŒ¯ä¹°å…¥ - Multiple markets in buy zone å¤šå¸‚åœºåŒæ—¶ä½å¸
// â„ï¸ Resonance Risk å…±æŒ¯é£é™© - Multiple markets in risk zone å¤šå¸‚åœºåŒæ—¶é«˜ä¼°
//
// TREND FILTER è¶‹åŠ¿è¿‡æ»¤:
// Price > MA = Risk signals suppressed é£é™©ä¿¡å·æŠ‘åˆ¶ï¼Œæ˜¾ç¤º ELEVATED (H)
// Price < MA = Risk signals active é£é™©ä¿¡å·æ¿€æ´»
//==============================================================================

//========================
// Mode (è¯„åˆ†é˜ˆå€¼è°ƒæ•´)
//========================
grpMode = "Mode"
mode = input.string("Standard", "ä¿¡å·æ¨¡å¼", options=["Aggressive","Standard","Conservative"], group=grpMode)

//========================
// Core Inputs
//========================
grp1 = "Core Settings"
rsiLen = input.int(14, "RSI Length", minval=2, group=grp1)

// è‡ªåŠ¨è·å–å›¾è¡¨å‘¨æœŸï¼Œæ— éœ€æ‰‹åŠ¨é€‰æ‹©
tfData = timeframe.period  // è‡ªåŠ¨è·å–å½“å‰å›¾è¡¨å‘¨æœŸ

// è‡ªåŠ¨æ£€æµ‹æ—¥å†…æ¨¡å¼: ä½¿ç”¨å†…ç½®å˜é‡ timeframe.isintraday
intradayMode = timeframe.isintraday  // è‡ªåŠ¨: æ—¥å†…å›¾è¡¨ = true, æ—¥çº¿/å‘¨çº¿ = false

grp2 = "Signal Thresholds"
// ä¿¡å·è§¦å‘é˜ˆå€¼
strongBotThreshold = input.int(6, "Panic Low Threshold", minval=3, maxval=10, group=grp2)
botThreshold = input.int(4, "Buy Zone Threshold", minval=2, maxval=8, group=grp2)
topThreshold = input.int(-4, "Caution Zone Threshold", minval=-8, maxval=-2, group=grp2)
strongTopThreshold = input.int(-6, "Risk Zone Threshold", minval=-10, maxval=-3, group=grp2)

grp3 = "Signal Logic"
cooldownIn = input.int(10, "Cooldown Bars", minval=0, group=grp3)
confirmBars = input.int(3, "Resonance Window", minval=0, group=grp3)
minAgree = input.int(2, "Min Markets for Resonance", minval=1, maxval=3, group=grp3)

// Trend Filter (è¶‹åŠ¿è¿‡æ»¤)
grp3b = "Trend Filter"
trendMALen = input.int(10, "Trend MA Length", minval=5, maxval=50, group=grp3b, tooltip="Price above this MA = uptrend. Risk signals only trigger when price breaks below.")
useTrendFilter = input.bool(true, "Enable Trend Filter", group=grp3b, tooltip="When enabled, risk signals only trigger if price is below trend MA.")

grp5 = "Symbols"
spySym = input.symbol("AMEX:SPY", "SPY", group=grp5)
qqqSym = input.symbol("NASDAQ:QQQ", "QQQ", group=grp5)
iwmSym = input.symbol("AMEX:IWM", "Russell2000 (IWM)", group=grp5)

// Breadth symbols
s5twSym = input.symbol("INDEX:S5TW", "S5TW (% > 20D MA)", group=grp5)
s5fiSym = input.symbol("INDEX:S5FI", "S5FI (% > 50D MA)", group=grp5)
nctwSym = input.symbol("INDEX:NCTW", "NCTW (% > 20D MA)", group=grp5)
ncfiSym = input.symbol("INDEX:NCFI", "NCFI (% > 50D MA)", group=grp5)
r2twSym = input.symbol("INDEX:R2TW", "R2TW (% > 20D MA)", group=grp5)
r2fiSym = input.symbol("INDEX:R2FI", "R2FI (% > 50D MA)", group=grp5)

// Up/Down Volume (æ–°å¢)
grp5b = "Volume Breadth (æ–°å¢)"
uvolSym = input.symbol("USI:UVOL", "Up Volume (NYSE - SPY/IWM)", group=grp5b)
dvolSym = input.symbol("USI:DVOL", "Down Volume (NYSE - SPY/IWM)", group=grp5b)
uvolqSym = input.symbol("USI:UVOLQ", "Up Volume (NASDAQ - QQQ)", group=grp5b)
dvolqSym = input.symbol("USI:DVOLQ", "Down Volume (NASDAQ - QQQ)", group=grp5b)

grp6 = "Plot"
plotMode = input.string("AUTO", "æ˜¾ç¤ºæ¨¡å¼", options=["AUTO","SPY","QQQ","IWM","AGG(å…±æŒ¯)"], group=grp6)
showDashboard = input.bool(true, "æ˜¾ç¤ºè¯„åˆ†é¢æ¿", group=grp6)

//========================
// Mode presets (è¯„åˆ†é˜ˆå€¼è°ƒæ•´)
//========================
// ä¸åŒæ¨¡å¼è°ƒæ•´ä¿¡å·é˜ˆå€¼æ•æ„Ÿåº¦
modeAdjust = mode == "Aggressive" ? 1 : mode == "Conservative" ? -1 : 0

// æ—¥å†…æ¨¡å¼é˜ˆå€¼é™ä½ (åªæœ‰RSI+Volä¸¤å› å­, æœ€å¤§åˆ†æ•°Â±4)
intradayAdjust = intradayMode ? 2 : 0
adjBotThreshold = botThreshold - modeAdjust - intradayAdjust
adjStrongBotThreshold = strongBotThreshold - modeAdjust - intradayAdjust
adjTopThreshold = topThreshold + modeAdjust + intradayAdjust
adjStrongTopThreshold = strongTopThreshold + modeAdjust + intradayAdjust

cooldownBars = mode == "Aggressive" ? 5 : mode == "Conservative" ? 15 : cooldownIn

//========================
// Helpers
//========================
// ä»·æ ¼æ•°æ®ç”¨å›¾è¡¨å‘¨æœŸ
f_sec(_sym, _expr) =>
    request.security(_sym, tfData, _expr, barmerge.gaps_off, barmerge.lookahead_off)

f_ohlc(_sym) =>
    request.security(_sym, tfData, [open, high, low, close], barmerge.gaps_off, barmerge.lookahead_off)

// å¹¿åº¦æ•°æ®å§‹ç»ˆç”¨æ—¥çº¿ (breadth indicators only have daily data)
f_secDaily(_sym, _expr) =>
    request.security(_sym, "D", _expr, barmerge.gaps_off, barmerge.lookahead_off)

f_rsi_from_close(_c) =>
    ta.rsi(_c, rsiLen)

f_recent(_cond, _bars) =>
    if _bars == 0
        _cond
    else
        bs = ta.barssince(_cond)
        not na(bs) and bs <= _bars

// å†·å´ï¼šåŒæ–¹å‘è§¦å‘å N bars å†…ä¸å…è®¸å†è§¦å‘
f_applyCooldown(_rawSig, _coolBars, _lastBar) =>
    can = na(_lastBar) or (bar_index - _lastBar > _coolBars)
    _rawSig and (_coolBars == 0 or can)

//========================
// Scoring Functions (æ ¸å¿ƒè¯„åˆ†é€»è¾‘)
//========================
// RSI è¯„åˆ†: åº•éƒ¨æ­£åˆ†ï¼Œé¡¶éƒ¨è´Ÿåˆ†
// ä¼˜åŒ–: æ”¶ç´§é¡¶éƒ¨é˜ˆå€¼ (60â†’65)
f_rsiScore(_rsi) =>
    score = 0.0
    if not na(_rsi)
        if _rsi < 30
            score := 2
        else if _rsi < 40
            score := 1
        else if _rsi > 75
            score := -2  // æ›´ä¸¥æ ¼ (åŸ70)
        else if _rsi > 65
            score := -1  // æ›´ä¸¥æ ¼ (åŸ60)
    score

// FI (50æ—¥) è¯„åˆ†: åº•éƒ¨æ ¸å¿ƒ
// ä¼˜åŒ–: å¢åŠ é¡¶éƒ¨æƒé‡ï¼Œå‡å°‘å‡ä¿¡å·
f_fiScore(_fi) =>
    score = 0.0
    if not na(_fi)
        if _fi < 25
            score := 3  // æåº¦è¶…å–
        else if _fi < 35
            score := 2
        else if _fi < 45
            score := 1
        else if _fi > 85
            score := -2  // æ–°å¢: æåº¦è¶…ä¹°æ‰å¤§æ‰£åˆ†
        else if _fi > 78
            score := -1  // æ›´ä¸¥æ ¼ (åŸ75)
    score

// TW (20æ—¥) è¯„åˆ†: é¡¶éƒ¨æ ¸å¿ƒ
// ä¼˜åŒ–: å¤§å¹…æ”¶ç´§é˜ˆå€¼å‡å°‘å‡é¡¶éƒ¨ä¿¡å·
f_twScore(_tw) =>
    score = 0.0
    if not na(_tw)
        if _tw > 82
            score := -3  // æ›´ä¸¥æ ¼ (åŸ75)
        else if _tw > 72
            score := -2  // æ›´ä¸¥æ ¼ (åŸ65)
        else if _tw > 68
            score := -1  // å¤§å¹…æ”¶ç´§ (åŸ55)
        else if _tw < 30
            score := 1  // æ›´ä¸¥æ ¼ (åŸ35)
    score

// Up/Down Volume è¯„åˆ†
// ä¼˜åŒ–: æ”¶ç´§é¡¶éƒ¨é˜ˆå€¼
f_volScore(_uvol, _dvol) =>
    score = 0.0
    if not na(_uvol) and not na(_dvol) and _dvol > 0
        ratio = _uvol / _dvol
        if ratio < 0.5
            score := 2  // ä¸‹è·Œæˆäº¤é‡ä¸»å¯¼ -> å¯èƒ½è§åº•
        else if ratio < 0.8
            score := 1
        else if ratio > 2.5
            score := -2  // æ›´ä¸¥æ ¼ (åŸ2.0)
        else if ratio > 1.8
            score := -1  // æ›´ä¸¥æ ¼ (åŸ1.5)
    score

// ç»¼åˆè¯„åˆ†å‡½æ•°
// intradayMode: æ—¥å†…æ¨¡å¼åªç”¨ RSI + Volume
f_totalScore(_rsi, _tw, _fi, _uvol, _dvol, _intraday) =>
    rsiS = f_rsiScore(_rsi)
    volS = f_volScore(_uvol, _dvol)
    // æ—¥å†…æ¨¡å¼è·³è¿‡ TW/FI (æ—¥çº¿æ•°æ®ä¸é€‚åˆå°æ—¶å›¾)
    fiS = _intraday ? 0.0 : f_fiScore(_fi)
    twS = _intraday ? 0.0 : f_twScore(_tw)
    total = rsiS + fiS + twS + volS
    [total, rsiS, fiS, twS, volS]

//========================
// Market data
//========================
[spyO, spyH, spyL, spyC] = f_ohlc(spySym)
[qqqO, qqqH, qqqL, qqqC] = f_ohlc(qqqSym)
[iwmO, iwmH, iwmL, iwmC] = f_ohlc(iwmSym)

spyRSI = f_rsi_from_close(spyC)
qqqRSI = f_rsi_from_close(qqqC)
iwmRSI = f_rsi_from_close(iwmC)

// å¹¿åº¦æ•°æ®å§‹ç»ˆç”¨æ—¥çº¿ (only daily data available)
s5tw = f_secDaily(s5twSym, close)
s5fi = f_secDaily(s5fiSym, close)
nctw = f_secDaily(nctwSym, close)
ncfi = f_secDaily(ncfiSym, close)
r2tw = f_secDaily(r2twSym, close)
r2fi = f_secDaily(r2fiSym, close)

// Up/Down Volume ä¹Ÿç”¨æ—¥çº¿ (intraday volume data unreliable for breadth)
uvol = f_secDaily(uvolSym, close)
dvol = f_secDaily(dvolSym, close)
uvolq = f_secDaily(uvolqSym, close)
dvolq = f_secDaily(dvolqSym, close)

//========================
// Calculate Scores per Market
//========================
// SPY ä½¿ç”¨ NYSE æˆäº¤é‡
[spyScore, spyRsiS, spyFiS, spyTwS, spyVolS] = f_totalScore(spyRSI, s5tw, s5fi, uvol, dvol, intradayMode)
// QQQ ä½¿ç”¨ NASDAQ æˆäº¤é‡
[qqqScore, qqqRsiS, qqqFiS, qqqTwS, qqqVolS] = f_totalScore(qqqRSI, nctw, ncfi, uvolq, dvolq, intradayMode)
// IWM ä½¿ç”¨ NYSE æˆäº¤é‡
[iwmScore, iwmRsiS, iwmFiS, iwmTwS, iwmVolS] = f_totalScore(iwmRSI, r2tw, r2fi, uvol, dvol, intradayMode)

//========================
// Signal Generation (åŸºäºè¯„åˆ† + è¶‹åŠ¿è¿‡æ»¤)
//========================
// Trend MA calculation (è¶‹åŠ¿å‡çº¿)
spyTrendMA = ta.sma(spyC, trendMALen)
qqqTrendMA = ta.sma(qqqC, trendMALen)
iwmTrendMA = ta.sma(iwmC, trendMALen)

// è¶‹åŠ¿çŠ¶æ€: ä»·æ ¼åœ¨MAä¹‹ä¸Š = ä¸Šå‡è¶‹åŠ¿
spyUptrend = spyC > spyTrendMA
qqqUptrend = qqqC > qqqTrendMA
iwmUptrend = iwmC > iwmTrendMA

// SPY signals
spyStrongBot = spyScore >= adjStrongBotThreshold
spyBot = spyScore >= adjBotThreshold and spyScore < adjStrongBotThreshold
// é£é™©ä¿¡å·: åªæœ‰è¶‹åŠ¿è¿‡æ»¤å…³é—­ OR ä»·æ ¼è·Œç ´MAæ‰è§¦å‘
spyTopCondition = spyScore <= adjTopThreshold and spyScore > adjStrongTopThreshold
spyStrongTopCondition = spyScore <= adjStrongTopThreshold
spyTop = spyTopCondition and (not useTrendFilter or not spyUptrend)
spyStrongTop = spyStrongTopCondition and (not useTrendFilter or not spyUptrend)
// é«˜ä¼°ä½†è¶‹åŠ¿è‰¯å¥½ (ç”¨äºDashboardæ˜¾ç¤º)
spyElevated = (spyTopCondition or spyStrongTopCondition) and spyUptrend and useTrendFilter

spyBotRaw = spyStrongBot or spyBot
spyTopRaw = spyStrongTop or spyTop

// QQQ signals
qqqStrongBot = qqqScore >= adjStrongBotThreshold
qqqBot = qqqScore >= adjBotThreshold and qqqScore < adjStrongBotThreshold
qqqTopCondition = qqqScore <= adjTopThreshold and qqqScore > adjStrongTopThreshold
qqqStrongTopCondition = qqqScore <= adjStrongTopThreshold
qqqTop = qqqTopCondition and (not useTrendFilter or not qqqUptrend)
qqqStrongTop = qqqStrongTopCondition and (not useTrendFilter or not qqqUptrend)
qqqElevated = (qqqTopCondition or qqqStrongTopCondition) and qqqUptrend and useTrendFilter

qqqBotRaw = qqqStrongBot or qqqBot
qqqTopRaw = qqqStrongTop or qqqTop

// IWM signals
iwmStrongBot = iwmScore >= adjStrongBotThreshold
iwmBot = iwmScore >= adjBotThreshold and iwmScore < adjStrongBotThreshold
iwmTopCondition = iwmScore <= adjTopThreshold and iwmScore > adjStrongTopThreshold
iwmStrongTopCondition = iwmScore <= adjStrongTopThreshold
iwmTop = iwmTopCondition and (not useTrendFilter or not iwmUptrend)
iwmStrongTop = iwmStrongTopCondition and (not useTrendFilter or not iwmUptrend)
iwmElevated = (iwmTopCondition or iwmStrongTopCondition) and iwmUptrend and useTrendFilter

iwmBotRaw = iwmStrongBot or iwmBot
iwmTopRaw = iwmStrongTop or iwmTop

// Cooldown state
var int spyLastBot = na
var int spyLastTop = na
var int qqqLastBot = na
var int qqqLastTop = na
var int iwmLastBot = na
var int iwmLastTop = na

spyBotTrig = f_applyCooldown(spyBotRaw, cooldownBars, spyLastBot)
spyTopTrig = f_applyCooldown(spyTopRaw, cooldownBars, spyLastTop)
qqqBotTrig = f_applyCooldown(qqqBotRaw, cooldownBars, qqqLastBot)
qqqTopTrig = f_applyCooldown(qqqTopRaw, cooldownBars, qqqLastTop)
iwmBotTrig = f_applyCooldown(iwmBotRaw, cooldownBars, iwmLastBot)
iwmTopTrig = f_applyCooldown(iwmTopRaw, cooldownBars, iwmLastTop)

if spyBotTrig
    spyLastBot := bar_index
if spyTopTrig
    spyLastTop := bar_index
if qqqBotTrig
    qqqLastBot := bar_index
if qqqTopTrig
    qqqLastTop := bar_index
if iwmBotTrig
    iwmLastBot := bar_index
if iwmTopTrig
    iwmLastTop := bar_index

//========================
// Aggregate resonance (edge-triggered)
//========================
spyBotRecent = f_recent(spyBotTrig, confirmBars)
qqqBotRecent = f_recent(qqqBotTrig, confirmBars)
iwmBotRecent = f_recent(iwmBotTrig, confirmBars)

spyTopRecent = f_recent(spyTopTrig, confirmBars)
qqqTopRecent = f_recent(qqqTopTrig, confirmBars)
iwmTopRecent = f_recent(iwmTopTrig, confirmBars)

agreeBot = (spyBotRecent ? 1 : 0) + (qqqBotRecent ? 1 : 0) + (iwmBotRecent ? 1 : 0)
agreeTop = (spyTopRecent ? 1 : 0) + (qqqTopRecent ? 1 : 0) + (iwmTopRecent ? 1 : 0)

aggBottom = agreeBot >= minAgree
aggTop    = agreeTop >= minAgree

aggBottomEdge = aggBottom and not aggBottom[1]
aggTopEdge    = aggTop and not aggTop[1]

//========================
// Plot selection
//========================
// ä½¿ç”¨ syminfo.ticker è·å–çº¯å“ç§åç§° (ä¸å«äº¤æ˜“æ‰€å‰ç¼€)
tickerName = str.upper(syminfo.ticker)

// S&P 500 ç³»åˆ—: SPY, SPX, ES (æœŸè´§), /ES, MES
isSpy = str.contains(tickerName, "SPY") or str.contains(tickerName, "SPX") or tickerName == "ES" or tickerName == "MES" or str.contains(tickerName, "ES1!")

// NASDAQ 100 ç³»åˆ—: QQQ, NDX, NQ (æœŸè´§), /NQ, MNQ  
isQqq = str.contains(tickerName, "QQQ") or str.contains(tickerName, "NDX") or tickerName == "NQ" or tickerName == "MNQ" or str.contains(tickerName, "NQ1!")

// Russell 2000 ç³»åˆ—: IWM, RUT, RTY (æœŸè´§), /RTY, M2K
isIwm = str.contains(tickerName, "IWM") or str.contains(tickerName, "RUT") or str.contains(tickerName, "RTY") or tickerName == "M2K"

modePlot = plotMode == "AUTO" ? (isSpy ? "SPY" : isQqq ? "QQQ" : isIwm ? "IWM" : "AGG(å…±æŒ¯)") : plotMode
showSpy = modePlot == "SPY"
showQqq = modePlot == "QQQ"
showIwm = modePlot == "IWM"
showAgg = modePlot == "AGG(å…±æŒ¯)"

// é€‰æ‹©å½“å‰æ˜¾ç¤ºçš„è¯„åˆ†
displayScore = showSpy ? spyScore : showQqq ? qqqScore : showIwm ? iwmScore : (spyScore + qqqScore + iwmScore) / 3
displayRsiS = showSpy ? spyRsiS : showQqq ? qqqRsiS : showIwm ? iwmRsiS : (spyRsiS + qqqRsiS + iwmRsiS) / 3
displayFiS = showSpy ? spyFiS : showQqq ? qqqFiS : showIwm ? iwmFiS : (spyFiS + qqqFiS + iwmFiS) / 3
displayTwS = showSpy ? spyTwS : showQqq ? qqqTwS : showIwm ? iwmTwS : (spyTwS + qqqTwS + iwmTwS) / 3
displayVolS = showSpy ? spyVolS : showQqq ? qqqVolS : showIwm ? iwmVolS : (spyVolS + qqqVolS + iwmVolS) / 3

//========================
// Plot shapes (æ–°æœ¯è¯­)
// ğŸš€ = Panic Low (ææ…Œä½ç‚¹, Score >= 6) - å¼ºçƒˆä¹°å…¥æœºä¼š
// ï¿½ = Buy Zone (ä½å¸åŒº, Score >= 4) - åˆ†æ‰¹å»ºä»“
// âš ï¸ = Reduce (å‡ä»“, Score <= -6 ä¸”è¶‹åŠ¿å‘ä¸‹) - é«˜é£é™©
// ï¿½ = Caution (è§‚æœ›, Score <= -4 ä¸”è¶‹åŠ¿å‘ä¸‹) - æ­¢ç›ˆè§‚æœ›
// ï¿½ = Elevated (é«˜ä¼°ä½†è¶‹åŠ¿è‰¯å¥½) - æŒæœ‰ä½†è°¨æ…
// ï¿½ğŸ”¥ = Resonance Buy (å¤šå¸‚åœºå…±æŒ¯ä¹°å…¥)
// â„ï¸ = Resonance Risk (å¤šå¸‚åœºå…±æŒ¯é£é™©)
//========================
// SPY
plotshape(showSpy and spyBotTrig and spyStrongBot, title="SPY Panic Low", style=shape.labelup, location=location.belowbar, color=color.new(color.lime, 0), textcolor=color.black, size=size.normal, text="ğŸš€")
plotshape(showSpy and spyBotTrig and spyBot, title="SPY Buy Zone", style=shape.triangleup, location=location.belowbar, color=color.new(color.lime, 0), size=size.small, text="ğŸ“ˆ")
plotshape(showSpy and spyTopTrig and spyStrongTop, title="SPY Reduce", style=shape.labeldown, location=location.abovebar, color=color.new(color.red, 0), textcolor=color.white, size=size.normal, text="âš ï¸")
plotshape(showSpy and spyTopTrig and spyTop, title="SPY Caution", style=shape.triangledown, location=location.abovebar, color=color.new(color.orange, 0), size=size.small, text="âš¡")
plotshape(showSpy and spyElevated and not spyElevated[1], title="SPY Elevated", style=shape.diamond, location=location.abovebar, color=color.new(color.yellow, 0), size=size.tiny, text="â­")

// QQQ
plotshape(showQqq and qqqBotTrig and qqqStrongBot, title="QQQ Panic Low", style=shape.labelup, location=location.belowbar, color=color.new(color.lime, 0), textcolor=color.black, size=size.normal, text="ğŸš€")
plotshape(showQqq and qqqBotTrig and qqqBot, title="QQQ Buy Zone", style=shape.triangleup, location=location.belowbar, color=color.new(color.lime, 0), size=size.small, text="ğŸ“ˆ")
plotshape(showQqq and qqqTopTrig and qqqStrongTop, title="QQQ Reduce", style=shape.labeldown, location=location.abovebar, color=color.new(color.red, 0), textcolor=color.white, size=size.normal, text="âš ï¸")
plotshape(showQqq and qqqTopTrig and qqqTop, title="QQQ Caution", style=shape.triangledown, location=location.abovebar, color=color.new(color.orange, 0), size=size.small, text="âš¡")
plotshape(showQqq and qqqElevated and not qqqElevated[1], title="QQQ Elevated", style=shape.diamond, location=location.abovebar, color=color.new(color.yellow, 0), size=size.tiny, text="â­")

// IWM
plotshape(showIwm and iwmBotTrig and iwmStrongBot, title="IWM Panic Low", style=shape.labelup, location=location.belowbar, color=color.new(color.lime, 0), textcolor=color.black, size=size.normal, text="ğŸš€")
plotshape(showIwm and iwmBotTrig and iwmBot, title="IWM Buy Zone", style=shape.triangleup, location=location.belowbar, color=color.new(color.lime, 0), size=size.small, text="ğŸ“ˆ")
plotshape(showIwm and iwmTopTrig and iwmStrongTop, title="IWM Reduce", style=shape.labeldown, location=location.abovebar, color=color.new(color.red, 0), textcolor=color.white, size=size.normal, text="âš ï¸")
plotshape(showIwm and iwmTopTrig and iwmTop, title="IWM Caution", style=shape.triangledown, location=location.abovebar, color=color.new(color.orange, 0), size=size.small, text="âš¡")
plotshape(showIwm and iwmElevated and not iwmElevated[1], title="IWM Elevated", style=shape.diamond, location=location.abovebar, color=color.new(color.yellow, 0), size=size.tiny, text="â­")

// AGG å…±æŒ¯
plotshape(showAgg and aggBottomEdge, title="Resonance Buy", style=shape.labelup, location=location.belowbar, color=color.new(color.lime, 0), textcolor=color.black, text="ğŸ”¥")
plotshape(showAgg and aggTopEdge, title="Resonance Risk", style=shape.labeldown, location=location.abovebar, color=color.new(color.red, 0), textcolor=color.white, text="â„ï¸")

//========================
// Dashboard (æ¸è¿›å¼é£é™©æè¿°)
//========================
// é€‰æ‹©å½“å‰è¶‹åŠ¿çŠ¶æ€
displayUptrend = showSpy ? spyUptrend : showQqq ? qqqUptrend : showIwm ? iwmUptrend : (spyUptrend and qqqUptrend) or (spyUptrend and iwmUptrend) or (qqqUptrend and iwmUptrend)
displayElevated = showSpy ? spyElevated : showQqq ? qqqElevated : showIwm ? iwmElevated : (spyElevated or qqqElevated or iwmElevated)

if showDashboard and barstate.islast
    var table dashboard = table.new(position.top_right, 3, 7, bgcolor=color.new(color.black, 80), frame_color=color.gray, frame_width=1, border_color=color.gray, border_width=1)
    
    // Header
    table.cell(dashboard, 0, 0, "Factor", text_color=color.white, text_size=size.small)
    table.cell(dashboard, 1, 0, "Score", text_color=color.white, text_size=size.small)
    table.cell(dashboard, 2, 0, "Weight", text_color=color.white, text_size=size.small)
    
    // RSI
    rsiColor = displayRsiS > 0 ? color.lime : displayRsiS < 0 ? color.red : color.gray
    table.cell(dashboard, 0, 1, "RSI", text_color=color.white, text_size=size.small)
    table.cell(dashboard, 1, 1, str.tostring(displayRsiS, "#.#"), text_color=rsiColor, text_size=size.small)
    table.cell(dashboard, 2, 1, "1x", text_color=color.gray, text_size=size.small)
    
    // FI (50D)
    fiColor = displayFiS > 0 ? color.lime : displayFiS < 0 ? color.red : color.gray
    table.cell(dashboard, 0, 2, "FI(50D)", text_color=color.white, text_size=size.small)
    table.cell(dashboard, 1, 2, str.tostring(displayFiS, "#.#"), text_color=fiColor, text_size=size.small)
    table.cell(dashboard, 2, 2, "Bottom", text_color=color.lime, text_size=size.small)
    
    // TW (20D)
    twColor = displayTwS > 0 ? color.lime : displayTwS < 0 ? color.red : color.gray
    table.cell(dashboard, 0, 3, "TW(20D)", text_color=color.white, text_size=size.small)
    table.cell(dashboard, 1, 3, str.tostring(displayTwS, "#.#"), text_color=twColor, text_size=size.small)
    table.cell(dashboard, 2, 3, "Top", text_color=color.red, text_size=size.small)
    
    // Volume
    volColor = displayVolS > 0 ? color.lime : displayVolS < 0 ? color.red : color.gray
    table.cell(dashboard, 0, 4, "Vol", text_color=color.white, text_size=size.small)
    table.cell(dashboard, 1, 4, str.tostring(displayVolS, "#.#"), text_color=volColor, text_size=size.small)
    table.cell(dashboard, 2, 4, "1x", text_color=color.gray, text_size=size.small)
    
    // Trend status
    trendText = displayUptrend ? "â†‘ UPTREND" : "â†“ DOWNTREND"
    trendColor = displayUptrend ? color.lime : color.red
    table.cell(dashboard, 0, 5, "Trend", text_color=color.white, text_size=size.small)
    table.cell(dashboard, 1, 5, trendText, text_color=trendColor, text_size=size.small)
    table.cell(dashboard, 2, 5, str.tostring(trendMALen) + "MA", text_color=color.gray, text_size=size.small)
    
    // Total with gradual risk descriptions
    totalColor = displayScore >= adjBotThreshold ? color.lime : displayScore <= adjTopThreshold ? (displayUptrend ? color.yellow : color.red) : color.gray
    table.cell(dashboard, 0, 6, "Total", text_color=color.white, text_size=size.normal)
    table.cell(dashboard, 1, 6, str.tostring(displayScore, "#.#"), text_color=totalColor, text_size=size.normal)
    // æ¸è¿›å¼é£é™©æè¿°
    signalText = displayScore >= adjStrongBotThreshold ? "PANIC LOW" : 
                 displayScore >= adjBotThreshold ? "ACCUMULATE" : 
                 displayElevated ? "ELEVATED" :
                 displayScore <= adjStrongTopThreshold ? "REDUCE" : 
                 displayScore <= adjTopThreshold ? "CAUTION" : 
                 "HOLD"
    table.cell(dashboard, 2, 6, signalText, text_color=totalColor, text_size=size.small)

//========================
// Alerts - AUTOæ¨¡å¼ (æ¨èä½¿ç”¨ï¼Œæ ¹æ®å½“å‰å›¾è¡¨è‡ªåŠ¨é€‰æ‹©)
//========================
// å½“å‰å›¾è¡¨çš„ä¹°å…¥/å–å‡ºä¿¡å· (åŸºäºAUTOè¯†åˆ«)
autoBotTrig = (isSpy and spyBotTrig) or (isQqq and qqqBotTrig) or (isIwm and iwmBotTrig)
autoStrongBot = (isSpy and spyBotTrig and spyStrongBot) or (isQqq and qqqBotTrig and qqqStrongBot) or (isIwm and iwmBotTrig and iwmStrongBot)
autoTopTrig = (isSpy and spyTopTrig) or (isQqq and qqqTopTrig) or (isIwm and iwmTopTrig)
autoStrongTop = (isSpy and spyTopTrig and spyStrongTop) or (isQqq and qqqTopTrig and qqqStrongTop) or (isIwm and iwmTopTrig and iwmStrongTop)

// æ™ºèƒ½ Alert - åªéœ€è®¾ç½®è¿™å‡ ä¸ªå³å¯
alertcondition(autoStrongBot, title="ğŸš€ Panic Low", message="ğŸš€ Panic Low - Strong buy opportunity - {{ticker}} @ {{time}}")
alertcondition(autoBotTrig, title="ğŸ“ˆ Buy Zone", message="ğŸ“ˆ Buy Zone entry signal - {{ticker}} @ {{time}}")
alertcondition(autoStrongTop, title="âš ï¸ Reduce", message="âš ï¸ Reduce - High risk, consider reducing - {{ticker}} @ {{time}}")
alertcondition(autoTopTrig, title="âš¡ Caution", message="âš¡ Caution - Consider taking profits - {{ticker}} @ {{time}}")
alertcondition(aggBottomEdge, title="ğŸ”¥ Resonance Buy", message="ğŸ”¥ Multi-market resonance buy - {{ticker}} @ {{time}}")
alertcondition(aggTopEdge, title="â„ï¸ Resonance Risk", message="â„ï¸ Multi-market resonance risk - {{ticker}} @ {{time}}")



